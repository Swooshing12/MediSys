<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local2="clr-namespace:MediSys.Converters"
             x:Class="MediSys.Views.Dashboard.CrearCitaPage"
             Title="Crear Nueva Cita"
             BackgroundColor="#F8F9FA">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Colores médicos consistentes -->
            <Color x:Key="MedicalBlue">#2E86AB</Color>
            <Color x:Key="MedicalTeal">#A23B72</Color>
            <Color x:Key="MedicalGreen">#F18F01</Color>
            <Color x:Key="MedicalWhite">#FFFFFF</Color>
            <Color x:Key="MedicalGray">#F8F9FA</Color>
            <Color x:Key="MedicalDarkBlue">#1A5A7A</Color>
            <Color x:Key="TextDark">#2C3E50</Color>
            <Color x:Key="TextLight">#7F8C8D</Color>
            <Color x:Key="AccentGreen">#27AE60</Color>
            <Color x:Key="AccentRed">#E74C3C</Color>
            <Color x:Key="AccentBlue">#3498DB</Color>
            <Color x:Key="TextPrimary">#1F2937</Color>
            <Color x:Key="TextSecondary">#6B7280</Color>
            <Color x:Key="SuccessGreen">#059669</Color>
            <Color x:Key="DangerRed">#DC2626</Color>
            

        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <StackLayout Padding="20" Spacing="25">

            <!-- HEADER MÉDICO CON PROGRESO -->
            <Border BackgroundColor="{StaticResource MedicalWhite}"
                    Stroke="Transparent" 
                    StrokeThickness="0"
                    Padding="25">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.1" Radius="15" Offset="0,5"/>
                </Border.Shadow>

                <!-- Fondo decorativo sutil -->
                <Grid>
                    <Rectangle Opacity="0.05">
                        <Rectangle.Fill>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="{StaticResource MedicalBlue}" Offset="0.0" />
                                <GradientStop Color="{StaticResource MedicalTeal}" Offset="1.0" />
                            </LinearGradientBrush>
                        </Rectangle.Fill>
                    </Rectangle>

                    <StackLayout Spacing="15">
                        <StackLayout Orientation="Horizontal" HorizontalOptions="Center" Spacing="12">
                            <Border BackgroundColor="{StaticResource MedicalBlue}"
                                    WidthRequest="50" HeightRequest="50">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="25" />
                                </Border.StrokeShape>
                                <Label Text="📝" FontSize="24" TextColor="White"
                                       HorizontalOptions="Center" VerticalOptions="Center" />
                            </Border>
                            <StackLayout VerticalOptions="Center">
                                <Label Text="Nueva Cita Médica" 
                                       FontSize="24" 
                                       FontAttributes="Bold" 
                                       TextColor="{StaticResource TextDark}"/>
                                <Label Text="Sistema de Gestión de Citas" 
                                       FontSize="14" 
                                       TextColor="{StaticResource TextLight}"/>
                            </StackLayout>
                        </StackLayout>

                        <!-- Progreso dinámico -->
                        <Border BackgroundColor="{StaticResource AccentBlue}"
                                Padding="12,8"
                                HorizontalOptions="Center">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="15" />
                            </Border.StrokeShape>
                            <Label Text="{Binding ProgresoTexto}" 
                                   FontSize="13" 
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   HorizontalOptions="Center" />
                        </Border>
                    </StackLayout>
                </Grid>
            </Border>

            <!-- PASO 1: TIPO DE CITA -->
            <Border BackgroundColor="{StaticResource MedicalWhite}" 
                    Stroke="Transparent" StrokeThickness="0"
                    Padding="25">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.08" Radius="12" Offset="0,4"/>
                </Border.Shadow>

                <StackLayout Spacing="20">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Border BackgroundColor="{StaticResource MedicalTeal}"
                                WidthRequest="35" HeightRequest="35">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="17" />
                            </Border.StrokeShape>
                            <Label Text="1" FontSize="18" FontAttributes="Bold" 
                                   TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <Label Text="Seleccionar Tipo de Cita" 
                               FontSize="20" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"
                               VerticalOptions="Center"/>
                    </StackLayout>

                    <CollectionView ItemsSource="{Binding TiposCita}" 
                                    SelectedItem="{Binding TipoCitaSeleccionado}" 
                                    SelectionMode="Single">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border Margin="0,6" BackgroundColor="{StaticResource MedicalGray}" 
                                        Stroke="#E1E8ED" StrokeThickness="1"
                                        Padding="20">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="12"/>
                                    </Border.StrokeShape>
                                    <Border.Triggers>
                                        <DataTrigger TargetType="Border" 
                                                   Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.IdTipoCita}" 
                                                   Value="{Binding IdTipoCita}">
                                            <Setter Property="BackgroundColor" Value="#E8F4FD"/>
                                            <Setter Property="Stroke" Value="{StaticResource MedicalBlue}"/>
                                            <Setter Property="StrokeThickness" Value="2"/>
                                        </DataTrigger>
                                    </Border.Triggers>

                                    <StackLayout Spacing="10">
                                        <StackLayout Orientation="Horizontal" Spacing="15">
                                            <Label Text="{Binding IconoTipo}" FontSize="28" VerticalOptions="Center"/>
                                            <StackLayout VerticalOptions="Center">
                                                <Label Text="{Binding NombreTipo}" 
                                                       FontSize="18" 
                                                       FontAttributes="Bold" 
                                                       TextColor="{StaticResource TextDark}"/>
                                                <Label Text="{Binding Descripcion}" 
                                                       FontSize="14" 
                                                       TextColor="{StaticResource TextLight}"/>
                                            </StackLayout>
                                        </StackLayout>
                                    </StackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>
            </Border>

            <!-- SECCIÓN VIRTUAL (Solo visible para citas virtuales) -->
            <Border IsVisible="{Binding MostrarOpcionesVirtuales}"
        BackgroundColor="{StaticResource MedicalWhite}" 
        Stroke="Transparent" StrokeThickness="0"
        Padding="25">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.08" Radius="12" Offset="0,4"/>
                </Border.Shadow>

                <StackLayout Spacing="20">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Border BackgroundColor="{StaticResource MedicalTeal}"
                    WidthRequest="35" HeightRequest="35">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="17" />
                            </Border.StrokeShape>
                            <Label Text="📹" FontSize="18" TextColor="White"
                       HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <Label Text="Configuración de Videollamada" 
                   FontSize="20" 
                   FontAttributes="Bold" 
                   TextColor="{StaticResource TextDark}"
                   VerticalOptions="Center"/>
                    </StackLayout>

                    <!-- Selección de Plataforma -->
                    <StackLayout Spacing="12">
                        <Label Text="📱 Plataforma de Videollamada:" 
                   FontSize="16" FontAttributes="Bold" 
                   TextColor="{StaticResource TextDark}"/>

                        <CollectionView ItemsSource="{Binding PlataformasVirtuales}" 
                           SelectedItem="{Binding PlataformaSeleccionada}" 
                           SelectionMode="Single">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="0,6" BackgroundColor="{StaticResource MedicalGray}" 
                                Stroke="#E1E8ED" StrokeThickness="1"
                                Padding="18">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12"/>
                                        </Border.StrokeShape>
                                        <Border.Triggers>
                                            <DataTrigger TargetType="Border" 
                                           Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.Codigo}" 
                                           Value="{Binding Codigo}">
                                                <Setter Property="BackgroundColor" Value="#E8F4FD"/>
                                                <Setter Property="Stroke" Value="{StaticResource MedicalBlue}"/>
                                                <Setter Property="StrokeThickness" Value="2"/>
                                            </DataTrigger>
                                        </Border.Triggers>

                                        <StackLayout Orientation="Horizontal" Spacing="15">
                                            <Label Text="{Binding Icono}" 
                                       FontSize="28" 
                                       VerticalOptions="Center"/>
                                            <StackLayout VerticalOptions="Center" Spacing="4">
                                                <Label Text="{Binding Nombre}" 
                                           FontSize="17" 
                                           FontAttributes="Bold" 
                                           TextColor="{StaticResource TextDark}"/>
                                                <Label Text="{Binding Descripcion}" 
                                           FontSize="14" 
                                           TextColor="{StaticResource TextLight}"/>
                                            </StackLayout>
                                        </StackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>

                    <!-- ID de Sala (Opcional) -->
                    <StackLayout Spacing="8">
                        <Label Text="🏷️ ID de Sala (Opcional):" 
                   FontSize="15" FontAttributes="Bold" 
                   TextColor="{StaticResource TextDark}"/>
                        <Border BackgroundColor="{StaticResource MedicalGray}" 
                    Stroke="#E1E8ED" StrokeThickness="1"
                    Padding="15">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="10"/>
                            </Border.StrokeShape>
                            <Entry Text="{Binding SalaVirtual}" 
                       Placeholder="Ej: Consulta-Dr-Garcia"
                       BackgroundColor="Transparent"
                       TextColor="{StaticResource TextDark}"
                       PlaceholderColor="{StaticResource TextLight}"
                       FontSize="16"/>
                        </Border>
                        <Label Text="💡 Si no especifica, se generará automáticamente" 
                   FontSize="12" 
                   TextColor="{StaticResource TextLight}"
                   HorizontalOptions="Center"/>
                    </StackLayout>

                    <!-- Información adicional -->
                    <Border BackgroundColor="#E8F5E8" 
                Stroke="{StaticResource AccentGreen}" 
                StrokeThickness="1"
                Padding="15">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <StackLayout Spacing="8">
                            <Label Text="📧 Enlace automático" 
                       FontSize="16" FontAttributes="Bold" 
                       TextColor="{StaticResource AccentGreen}"/>
                            <Label Text="Se generará automáticamente un enlace de videollamada y se enviará al paciente por correo electrónico junto con la confirmación de la cita." 
                       FontSize="14" 
                       TextColor="{StaticResource TextDark}"/>
                        </StackLayout>
                    </Border>
                </StackLayout>
            </Border>

            <!-- PASO 2: BUSCAR/CREAR PACIENTE -->
            <Border IsVisible="{Binding TipoCitaSeleccionado, Converter={StaticResource ObjectToBoolConverter}}"
                    BackgroundColor="{StaticResource MedicalWhite}" 
                    Stroke="Transparent" StrokeThickness="0"
                    Padding="25">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.08" Radius="12" Offset="0,4"/>
                </Border.Shadow>

                <StackLayout Spacing="20">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Border BackgroundColor="{StaticResource AccentGreen}"
                                WidthRequest="35" HeightRequest="35">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="17" />
                            </Border.StrokeShape>
                            <Label Text="2" FontSize="18" FontAttributes="Bold" 
                                   TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <Label Text="Identificar Paciente" 
                               FontSize="20" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"
                               VerticalOptions="Center"/>
                    </StackLayout>

                    <!-- Búsqueda por cédula mejorada -->
                    <StackLayout Spacing="12">
                        <Label Text="Cédula del Paciente:" 
                               FontSize="16" FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"/>

                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                            <Border Grid.Column="0" BackgroundColor="{StaticResource MedicalGray}" 
                                    Stroke="#E1E8ED" StrokeThickness="1"
                                    Padding="15">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <Entry Text="{Binding CedulaBusqueda}"
                                       Placeholder="Ingrese número de cédula (10 dígitos)"
                                       Keyboard="Numeric"
                                       MaxLength="10"
                                       BackgroundColor="Transparent"
                                       TextColor="{StaticResource TextDark}"
                                       PlaceholderColor="{StaticResource TextLight}"
                                       FontSize="16"/>
                            </Border>

                            <Button Grid.Column="1" Text="🔍 Buscar" 
                                    Command="{Binding BuscarPacienteCommand}"
                                    FontSize="15"
                                    FontAttributes="Bold"
                                    TextColor="White"
                                    WidthRequest="110"
                                    HeightRequest="50"
                                    CornerRadius="10">
                                <Button.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Color="{StaticResource AccentGreen}" Offset="0.0" />
                                        <GradientStop Color="#229954" Offset="1.0" />
                                    </LinearGradientBrush>
                                </Button.Background>
                            </Button>
                        </Grid>
                    </StackLayout>

                    <!-- PACIENTE ENCONTRADO MEJORADO -->
                    <Frame IsVisible="{Binding PacienteEncontrado}"
BackgroundColor="#ECFDF5"
HasShadow="True"
CornerRadius="16"
Padding="20"
BorderColor="{StaticResource SuccessGreen}"
Margin="0,10">
                        <StackLayout Spacing="14">

                            <!-- Encabezado -->
                            <StackLayout Orientation="Horizontal" Spacing="8">
                                <Label Text="✅" FontSize="18" VerticalOptions="Center" />
                                <Label Text="Paciente Encontrado"
            FontSize="16"
            FontAttributes="Bold"
            TextColor="{StaticResource SuccessGreen}"
            VerticalOptions="Center" />
                            </StackLayout>

                            <!-- Nombre completo -->
                            <Label Text="{Binding PacienteSeleccionado.NombreCompleto}"
        FontSize="20"
        FontAttributes="Bold"
        TextColor="{StaticResource TextPrimary}" />

                            <!-- Datos básicos -->
                            <Grid ColumnDefinitions="*,*"
       RowDefinitions="Auto,Auto,Auto"
       ColumnSpacing="20" RowSpacing="6">

                                <!-- Cédula -->
                                <Label Grid.Row="0" Grid.Column="0"
            Text="{Binding PacienteSeleccionado.CedulaString, StringFormat='🪪 Cédula: {0}'}"
            FontSize="14" TextColor="{StaticResource TextSecondary}" />

                                <!-- Edad -->
                                <Label Grid.Row="0" Grid.Column="1"
            Text="{Binding PacienteSeleccionado.EdadDisplay, StringFormat='🎂 Edad: {0} años'}"
            FontSize="14" TextColor="{StaticResource TextSecondary}" />

                                <!-- Sexo -->
                                <Label Grid.Row="1" Grid.Column="0"
            Text="{Binding PacienteSeleccionado.SexoDisplay}"
            FontSize="14" TextColor="{StaticResource TextSecondary}" />

                                <!-- Tipo de sangre -->
                                <Label Grid.Row="1" Grid.Column="1"
            Text="{Binding PacienteSeleccionado.TipoSangre, StringFormat='🩸 Sangre: {0}'}"
            FontSize="14" TextColor="{StaticResource TextSecondary}" />

                                <!-- Nacionalidad -->
                                <Label Grid.Row="2" Grid.Column="0"
            Text="{Binding PacienteSeleccionado.Nacionalidad, StringFormat='🌎 {0}'}"
            FontSize="14" TextColor="{StaticResource TextSecondary}" />

                                <!-- Número seguro -->
                                <Label Grid.Row="2" Grid.Column="1"
            Text="{Binding PacienteSeleccionado.NumeroSeguro, StringFormat='🛡️ Seguro: {0}'}"
            FontSize="14" TextColor="{StaticResource TextSecondary}" />

                            </Grid>

                            <!-- Contactos -->
                            <StackLayout Spacing="4" Margin="0,10,0,0">
                                <Label Text="📞 Contactos"
            FontSize="14"
            FontAttributes="Bold"
            TextColor="{StaticResource TextPrimary}" />
                                <Label Text="{Binding PacienteSeleccionado.Telefono, StringFormat='Teléfono: {0}'}"
            FontSize="13" TextColor="{StaticResource TextSecondary}" />
                                <Label Text="{Binding PacienteSeleccionado.Correo, StringFormat='Correo: {0}'}"
            FontSize="13" TextColor="{StaticResource TextSecondary}" />
                            </StackLayout>

                            <!-- Contacto de emergencia -->
                            <StackLayout Spacing="4">
                                <Label Text="🚨 Contacto de Emergencia"
            FontSize="14"
            FontAttributes="Bold"
            TextColor="{StaticResource DangerRed}" />
                                <Label Text="{Binding PacienteSeleccionado.ContactoEmergencia, StringFormat='Nombre: {0}'}"
            FontSize="13" TextColor="{StaticResource TextSecondary}" />
                                <Label Text="{Binding PacienteSeleccionado.TelefonoEmergencia, StringFormat='Teléfono: {0}'}"
            FontSize="13" TextColor="{StaticResource TextSecondary}" />
                            </StackLayout>

                            <!-- Alergias y antecedentes -->
                            <StackLayout Spacing="4">
                                <Label Text="⚕️ Antecedentes Médicos"
            FontSize="14"
            FontAttributes="Bold"
            TextColor="{StaticResource TextPrimary}" />
                                <Label Text="{Binding PacienteSeleccionado.AntecedentesMedicos}"
            FontSize="13" TextColor="{StaticResource TextSecondary}" />

                                <Label Text="🌿 Alergias"
            FontSize="14"
            FontAttributes="Bold"
            TextColor="{StaticResource TextPrimary}" />
                                <Label Text="{Binding PacienteSeleccionado.Alergias}"
            FontSize="13" TextColor="{StaticResource TextSecondary}" />
                            </StackLayout>

                        </StackLayout>
                    </Frame>

                    <!-- Paciente no encontrado -->
                    <Border IsVisible="{Binding MostrarFormularioPaciente}" 
                            BackgroundColor="#FFF3E0" 
                            Stroke="{StaticResource MedicalGreen}" 
                            StrokeThickness="2"
                            Padding="20">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <StackLayout Spacing="15">
                            <Label Text="⚠️ Paciente No Encontrado" 
                                   FontSize="16" 
                                   FontAttributes="Bold" 
                                   TextColor="{StaticResource MedicalGreen}"/>
                            <Label Text="El paciente no está registrado en el sistema. Es necesario registrarlo primero." 
                                   FontSize="14" 
                                   TextColor="{StaticResource TextDark}"/>

                            <Button Text="➕ Registrar Nuevo Paciente" 
                                    Command="{Binding AbrirModalCrearPacienteCommand}"
                                    FontSize="16"
                                    FontAttributes="Bold"
                                    TextColor="White"
                                    HeightRequest="50"
                                    CornerRadius="12">
                                <Button.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Color="{StaticResource MedicalGreen}" Offset="0.0" />
                                        <GradientStop Color="#E67E22" Offset="1.0" />
                                    </LinearGradientBrush>
                                </Button.Background>
                            </Button>
                        </StackLayout>
                    </Border>
                </StackLayout>
            </Border>

            <!-- PASO 3: SELECCIÓN DE MÉDICO -->
            <Border IsVisible="{Binding PacienteSeleccionado, Converter={StaticResource ObjectToBoolConverter}}"
                    BackgroundColor="{StaticResource MedicalWhite}" 
                    Stroke="Transparent" StrokeThickness="0"
                    Padding="25">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.08" Radius="12" Offset="0,4"/>
                </Border.Shadow>

                <StackLayout Spacing="20">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Border BackgroundColor="{StaticResource MedicalBlue}"
                                WidthRequest="35" HeightRequest="35">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="17" />
                            </Border.StrokeShape>
                            <Label Text="3" FontSize="18" FontAttributes="Bold" 
                                   TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <Label Text="Seleccionar Médico" 
                               FontSize="20" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"
                               VerticalOptions="Center"/>
                    </StackLayout>

                    <!-- Selección de Sucursal -->
                    <StackLayout Spacing="10">
                        <Label Text="🏥 Sucursal Médica:" 
                               FontSize="16" FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"/>
                        <Border BackgroundColor="{StaticResource MedicalGray}" 
                                Stroke="#E1E8ED" StrokeThickness="1"
                                Padding="15">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="10"/>
                            </Border.StrokeShape>
                            <Picker ItemsSource="{Binding Sucursales}" 
                                    SelectedItem="{Binding SucursalSeleccionada}"
                                    ItemDisplayBinding="{Binding Nombre}"
                                    Title="Seleccione una sucursal"
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource TextDark}"
                                    TitleColor="{StaticResource TextLight}"
                                    FontSize="16"/>
                        </Border>
                    </StackLayout>

                    <!-- Selección de Especialidad -->
                    <StackLayout Spacing="10">
                        <Label Text="🩺 Especialidad Médica:" 
                               FontSize="16" FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"/>
                        <Border BackgroundColor="{StaticResource MedicalGray}" 
                                Stroke="#E1E8ED" StrokeThickness="1"
                                Padding="15">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="10"/>
                            </Border.StrokeShape>
                            <Picker ItemsSource="{Binding Especialidades}" 
                                    SelectedItem="{Binding EspecialidadSeleccionada}"
                                    ItemDisplayBinding="{Binding Nombre}"
                                    Title="Seleccione una especialidad"
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource TextDark}"
                                    TitleColor="{StaticResource TextLight}"
                                    FontSize="16"
                                    IsEnabled="{Binding SucursalSeleccionada, Converter={StaticResource ObjectToBoolConverter}}"/>
                        </Border>

                        <Label Text="{Binding Especialidades.Count, StringFormat='✅ {0} especialidades disponibles'}" 
                               FontSize="13" 
                               TextColor="{StaticResource AccentGreen}"
                               FontAttributes="Bold" />
                    </StackLayout>

                    <!-- Selección de Doctor -->
                    <StackLayout Spacing="12">
                        <Label Text="👨‍⚕️ Doctor Especialista:" 
                               FontSize="16" FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"/>

                        <CollectionView ItemsSource="{Binding Doctores}" 
                                        SelectedItem="{Binding DoctorSeleccionado}" 
                                        SelectionMode="Single"
                                        IsVisible="{Binding Doctores.Count, Converter={StaticResource CountToBoolConverter}}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="0,6" BackgroundColor="{StaticResource MedicalGray}" 
                                            Stroke="#E1E8ED" StrokeThickness="1"
                                            Padding="18">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12"/>
                                        </Border.StrokeShape>
                                        <Border.Triggers>
                                            <DataTrigger TargetType="Border" 
                                                       Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.IdDoctor}" 
                                                       Value="{Binding IdDoctor}">
                                                <Setter Property="BackgroundColor" Value="#E8F4FD"/>
                                                <Setter Property="Stroke" Value="{StaticResource MedicalBlue}"/>
                                                <Setter Property="StrokeThickness" Value="2"/>
                                            </DataTrigger>
                                        </Border.Triggers>

                                        <StackLayout Orientation="Horizontal" Spacing="15">
                                            <Border BackgroundColor="{StaticResource MedicalBlue}" 
                                                    WidthRequest="55" HeightRequest="55" 
                                                    StrokeThickness="0"
                                                    VerticalOptions="Center">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="27"/>
                                                </Border.StrokeShape>
                                                <Label Text="👨‍⚕️" 
                                                       FontSize="24" 
                                                       HorizontalOptions="Center" 
                                                       VerticalOptions="Center"/>
                                            </Border>
                                            <StackLayout VerticalOptions="Center" Spacing="4">
                                                <Label Text="{Binding Nombres, StringFormat='Dr. {0}'}" 
                                                       FontSize="17" 
                                                       FontAttributes="Bold" 
                                                       TextColor="{StaticResource TextDark}"/>
                                                <Label Text="{Binding Apellidos}" 
                                                       FontSize="15" 
                                                       TextColor="{StaticResource TextLight}"/>
                                                <Label Text="{Binding TituloProfesional}" 
                                                       FontSize="13" 
                                                       TextColor="{StaticResource MedicalBlue}"
                                                       FontAttributes="Bold"/>
                                            </StackLayout>
                                        </StackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <!-- Mensaje cuando no hay doctores -->
                        <Border BackgroundColor="#FFF3E0" 
                                Stroke="{StaticResource MedicalGreen}" 
                                StrokeThickness="1"
                                Padding="20"
                                IsVisible="{Binding Doctores.Count, Converter={StaticResource CountToInverseBoolConverter}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <Label Text="⚠️ No hay doctores disponibles para esta especialidad y sucursal" 
                                   FontSize="15" 
                                   TextColor="{StaticResource MedicalGreen}"
                                   FontAttributes="Bold"
                                   HorizontalOptions="Center" />
                        </Border>
                    </StackLayout>
                </StackLayout>
            </Border>

            <!-- PASO 4: CALENDARIO Y HORARIOS -->
            <Border IsVisible="{Binding DoctorSeleccionado, Converter={StaticResource ObjectToBoolConverter}}"
                    BackgroundColor="{StaticResource MedicalWhite}" 
                    Stroke="Transparent" StrokeThickness="0"
                    Padding="25">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.08" Radius="12" Offset="0,4"/>
                </Border.Shadow>

                <StackLayout Spacing="20">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Border BackgroundColor="{StaticResource AccentRed}"
                                WidthRequest="35" HeightRequest="35">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="17" />
                            </Border.StrokeShape>
                            <Label Text="4" FontSize="18" FontAttributes="Bold" 
                                   TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <Label Text="Seleccionar Fecha y Hora" 
                               FontSize="20" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"
                               VerticalOptions="Center"/>
                    </StackLayout>

                    <!-- Navegación de semana mejorada -->
                    <Border BackgroundColor="{StaticResource MedicalGray}" 
                            Stroke="#E1E8ED" StrokeThickness="1" 
                            Padding="15">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">
                            <Button Grid.Column="0" Text="◀" 
                                   Command="{Binding SemanaAnteriorCommand}"
                                   BackgroundColor="{StaticResource MedicalBlue}" 
                                   TextColor="White" 
                                   WidthRequest="45" 
                                   HeightRequest="45"
                                   FontSize="18"
                                   CornerRadius="22"/>
                            <Label Grid.Column="1" Text="{Binding TituloSemana}" 
                                  FontSize="17" 
                                  FontAttributes="Bold" 
                                  VerticalOptions="Center" 
                                  HorizontalOptions="Center"
                                  TextColor="{StaticResource TextDark}"/>
                            <Button Grid.Column="2" Text="▶" 
                                   Command="{Binding SemanaSiguienteCommand}"
                                   BackgroundColor="{StaticResource MedicalBlue}" 
                                   TextColor="White" 
                                   WidthRequest="45" 
                                   HeightRequest="45"
                                   FontSize="18"
                                   CornerRadius="22"/>
                        </Grid>
                    </Border>

                    <!-- Calendario de horarios disponibles -->
                    <StackLayout Spacing="12">
                        <Label Text="📅 Horarios Disponibles:" 
                               FontSize="16" FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"/>

                        <CollectionView ItemsSource="{Binding SlotsDisponibles}" 
                                       SelectedItem="{Binding SlotSeleccionado}" 
                                       SelectionMode="Single">
                            <CollectionView.ItemsLayout>
                                <GridItemsLayout Orientation="Vertical" 
                                              Span="3" 
                                              VerticalItemSpacing="10" 
                                              HorizontalItemSpacing="10"/>
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border BackgroundColor="{StaticResource MedicalGray}" 
                                           Stroke="#E1E8ED"
                                           StrokeThickness="1"
                                           HeightRequest="75">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="10"/>
                                        </Border.StrokeShape>
                                        <Border.Triggers>
                                            <DataTrigger TargetType="Border" 
                                                       Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.FechaHora}" 
                                                       Value="{Binding FechaHora}">
                                                <Setter Property="BackgroundColor" Value="{StaticResource MedicalBlue}"/>
                                                <Setter Property="Stroke" Value="{StaticResource MedicalBlue}"/>
                                                <Setter Property="StrokeThickness" Value="2"/>
                                            </DataTrigger>
                                            <DataTrigger TargetType="Border" Binding="{Binding Disponible}" Value="False">
                                                <Setter Property="BackgroundColor" Value="#FFEBEE"/>
                                                <Setter Property="Stroke" Value="{StaticResource AccentRed}"/>
                                                <Setter Property="Opacity" Value="0.6"/>
                                            </DataTrigger>
                                        </Border.Triggers>

                                        <StackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="3">
                                            <Label Text="{Binding Fecha, StringFormat='{0:dd/MM}'}" 
                                                  FontSize="12" 
                                                  FontAttributes="Bold" 
                                                  HorizontalOptions="Center"
                                                  TextColor="{StaticResource TextDark}">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label" 
                                                               Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.FechaHora}" 
                                                               Value="{Binding FechaHora}">
                                                        <Setter Property="TextColor" Value="White"/>
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                            <Label Text="{Binding Hora}" 
                                                  FontSize="14" 
                                                  FontAttributes="Bold" 
                                                  HorizontalOptions="Center"
                                                  TextColor="{StaticResource TextDark}">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label" 
                                                               Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.FechaHora}" 
                                                               Value="{Binding FechaHora}">
                                                        <Setter Property="TextColor" Value="White"/>
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                            <Label FontSize="10" 
                                                   TextColor="{StaticResource AccentGreen}"
                                                   FontAttributes="Bold"
                                                   HorizontalOptions="Center">
                                                <Label.Text>
                                                    <Binding Path="Disponible">
                                                        <Binding.Converter>
                                                            <local2:BoolToAvailabilityTextConverter/>
                                                        </Binding.Converter>
                                                    </Binding>
                                                </Label.Text>
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label" Binding="{Binding Disponible}" Value="False">
                                                        <Setter Property="TextColor" Value="{StaticResource AccentRed}"/>
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="Label" 
                                                               Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.FechaHora}" 
                                                               Value="{Binding FechaHora}">
                                                        <Setter Property="TextColor" Value="White"/>
                                                        <Setter Property="Opacity" Value="0.9"/>
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                        </StackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>

                    <!-- Detalles de la cita -->
                    <StackLayout IsVisible="{Binding SlotSeleccionado, Converter={StaticResource ObjectToBoolConverter}}" 
                                 Spacing="15">
                        <Label Text="📝 Detalles de la Cita" 
                               FontSize="18" FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"/>

                        <StackLayout Spacing="8">
                            <Label Text="Motivo de la consulta *:" 
                                   FontSize="15" FontAttributes="Bold" 
                                   TextColor="{StaticResource TextDark}"/>
                            <Border BackgroundColor="{StaticResource MedicalGray}" 
                                    Stroke="#E1E8ED" StrokeThickness="1"
                                    Padding="15">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <Entry Text="{Binding MotivoCita}" 
                                      Placeholder="Describa el motivo de la consulta médica"
                                      BackgroundColor="Transparent"
                                      TextColor="{StaticResource TextDark}"
                                      PlaceholderColor="{StaticResource TextLight}"
                                      FontSize="16"
                                      HeightRequest="45"/>
                            </Border>
                        </StackLayout>

                        <StackLayout Spacing="8">
                            <Label Text="Notas adicionales:" 
                                   FontSize="15" FontAttributes="Bold" 
                                   TextColor="{StaticResource TextDark}"/>
                            <Border BackgroundColor="{StaticResource MedicalGray}" 
                                    Stroke="#E1E8ED" StrokeThickness="1"
                                    Padding="15">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <Editor Text="{Binding NotasCita}" 
                                       Placeholder="Información adicional para el médico (opcional)"
                                       BackgroundColor="Transparent"
                                       TextColor="{StaticResource TextDark}"
                                       PlaceholderColor="{StaticResource TextLight}"
                                       FontSize="15"
                                       HeightRequest="70"/>
                            </Border>
                        </StackLayout>
                    </StackLayout>

                    <!-- Resumen final profesional -->
                    <Border IsVisible="{Binding SlotSeleccionado, Converter={StaticResource ObjectToBoolConverter}}" 
                           BackgroundColor="#E8F5E8" 
                           Stroke="{StaticResource AccentGreen}" 
                           StrokeThickness="2"
                           Padding="20">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="15"/>
                        </Border.StrokeShape>
                        <StackLayout Spacing="10">
                            <Label Text="📋 Resumen de la Cita Médica" 
                                   FontSize="17" FontAttributes="Bold" 
                                   TextColor="#2E7D32"/>
                            <Label Text="{Binding PacienteSeleccionado.NombreCompleto, StringFormat='👤 Paciente: {0}'}" 
                                  TextColor="{StaticResource TextDark}" FontSize="14"/>
                            <Label Text="{Binding DoctorSeleccionado.NombreCompleto, StringFormat='👨‍⚕️ Doctor: Dr. {0}'}" 
                                  TextColor="{StaticResource TextDark}" FontSize="14"/>
                            <Label Text="{Binding SucursalSeleccionada.Nombre, StringFormat='🏥 Sucursal: {0}'}" 
                                  TextColor="{StaticResource TextDark}" FontSize="14"/>
                            <Label Text="{Binding SlotSeleccionado.FechaHora, StringFormat='📅 Fecha: {0:dd/MM/yyyy HH:mm}'}" 
                                  TextColor="{StaticResource TextDark}" FontSize="14"/>
                            <Label Text="{Binding TipoCitaSeleccionado.NombreTipo, StringFormat='📋 Tipo: {0}'}" 
                                  TextColor="{StaticResource TextDark}" FontSize="14"/>
                        </StackLayout>
                    </Border>

                    <!-- Botón crear cita mejorado -->
                    <Button Text="✅ Crear Cita Médica" 
                           Command="{Binding CrearCitaCommand}"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="White"
                           HeightRequest="55"
                           CornerRadius="15"
                           IsEnabled="{Binding PuedeCrearCita}">
                        <Button.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                <GradientStop Color="{StaticResource AccentGreen}" Offset="0.0" />
                                <GradientStop Color="#229954" Offset="1.0" />
                            </LinearGradientBrush>
                        </Button.Background>
                        <Button.Shadow>
                            <Shadow Brush="{StaticResource AccentGreen}" Opacity="0.4" Radius="10" Offset="0,4" />
                        </Button.Shadow>
                        <Button.Style>
                            <Style TargetType="Button">
                                <Style.Triggers>
                                    <Trigger TargetType="Button" Property="IsEnabled" Value="False">
                                        <Setter Property="BackgroundColor" Value="#BDBDBD"/>
                                        <Setter Property="Shadow" Value="{x:Null}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackLayout>
            </Border>

            <!-- Loading Indicator médico -->
            <Border IsVisible="{Binding IsLoading}" 
                    BackgroundColor="{StaticResource MedicalWhite}"
                    Stroke="Transparent"
                    Padding="30">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.1" Radius="15" Offset="0,5"/>
                </Border.Shadow>

                <StackLayout HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Spacing="15">
                    <ActivityIndicator IsRunning="{Binding IsLoading}" 
                                     Color="{StaticResource MedicalBlue}" 
                                     WidthRequest="50"
                                     HeightRequest="50"/>
                    <Label Text="Procesando cita médica..." 
                          FontSize="16" 
                          FontAttributes="Bold"
                          TextColor="{StaticResource TextDark}"
                          HorizontalOptions="Center"/>
                    <Label Text="Por favor espere un momento" 
                          FontSize="14" 
                          TextColor="{StaticResource TextLight}"
                          HorizontalOptions="Center"/>
                </StackLayout>
            </Border>

            <!-- Botón Cancelar mejorado -->
            <Button Text="❌ Cancelar Proceso" 
                   Command="{Binding CancelarCommand}"
                   FontSize="16"
                   FontAttributes="Bold"
                   TextColor="White"
                   HeightRequest="50"
                   CornerRadius="12"
                   Margin="0,10,0,25">
                <Button.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                        <GradientStop Color="{StaticResource AccentRed}" Offset="0.0" />
                        <GradientStop Color="#C0392B" Offset="1.0" />
                    </LinearGradientBrush>
                </Button.Background>
            </Button>

        </StackLayout>
    </ScrollView>
</ContentPage>