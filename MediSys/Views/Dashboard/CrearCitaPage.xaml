<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local2="clr-namespace:MediSys.Converters"
             x:Class="MediSys.Views.Dashboard.CrearCitaPage"
             Title="Crear Nueva Cita"
             BackgroundColor="#F8F9FA">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Colores mÃ©dicos consistentes -->
            <Color x:Key="MedicalBlue">#2E86AB</Color>
            <Color x:Key="MedicalTeal">#A23B72</Color>
            <Color x:Key="MedicalGreen">#F18F01</Color>
            <Color x:Key="MedicalWhite">#FFFFFF</Color>
            <Color x:Key="MedicalGray">#F8F9FA</Color>
            <Color x:Key="MedicalDarkBlue">#1A5A7A</Color>
            <Color x:Key="TextDark">#2C3E50</Color>
            <Color x:Key="TextLight">#7F8C8D</Color>
            <Color x:Key="AccentGreen">#27AE60</Color>
            <Color x:Key="AccentRed">#E74C3C</Color>
            <Color x:Key="AccentBlue">#3498DB</Color>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <StackLayout Padding="20" Spacing="25">

            <!-- HEADER MÃ‰DICO CON PROGRESO -->
            <Border BackgroundColor="{StaticResource MedicalWhite}"
                    Stroke="Transparent" 
                    StrokeThickness="0"
                    Padding="25">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.1" Radius="15" Offset="0,5"/>
                </Border.Shadow>

                <!-- Fondo decorativo sutil -->
                <Grid>
                    <Rectangle Opacity="0.05">
                        <Rectangle.Fill>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="{StaticResource MedicalBlue}" Offset="0.0" />
                                <GradientStop Color="{StaticResource MedicalTeal}" Offset="1.0" />
                            </LinearGradientBrush>
                        </Rectangle.Fill>
                    </Rectangle>

                    <StackLayout Spacing="15">
                        <StackLayout Orientation="Horizontal" HorizontalOptions="Center" Spacing="12">
                            <Border BackgroundColor="{StaticResource MedicalBlue}"
                                    WidthRequest="50" HeightRequest="50">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="25" />
                                </Border.StrokeShape>
                                <Label Text="ðŸ“" FontSize="24" TextColor="White"
                                       HorizontalOptions="Center" VerticalOptions="Center" />
                            </Border>
                            <StackLayout VerticalOptions="Center">
                                <Label Text="Nueva Cita MÃ©dica" 
                                       FontSize="24" 
                                       FontAttributes="Bold" 
                                       TextColor="{StaticResource TextDark}"/>
                                <Label Text="Sistema de GestiÃ³n de Citas" 
                                       FontSize="14" 
                                       TextColor="{StaticResource TextLight}"/>
                            </StackLayout>
                        </StackLayout>

                        <!-- Progreso dinÃ¡mico -->
                        <Border BackgroundColor="{StaticResource AccentBlue}"
                                Padding="12,8"
                                HorizontalOptions="Center">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="15" />
                            </Border.StrokeShape>
                            <Label Text="{Binding ProgresoTexto}" 
                                   FontSize="13" 
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   HorizontalOptions="Center" />
                        </Border>
                    </StackLayout>
                </Grid>
            </Border>

            <!-- PASO 1: TIPO DE CITA -->
            <Border BackgroundColor="{StaticResource MedicalWhite}" 
                    Stroke="Transparent" StrokeThickness="0"
                    Padding="25">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.08" Radius="12" Offset="0,4"/>
                </Border.Shadow>

                <StackLayout Spacing="20">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Border BackgroundColor="{StaticResource MedicalTeal}"
                                WidthRequest="35" HeightRequest="35">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="17" />
                            </Border.StrokeShape>
                            <Label Text="1" FontSize="18" FontAttributes="Bold" 
                                   TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <Label Text="Seleccionar Tipo de Cita" 
                               FontSize="20" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"
                               VerticalOptions="Center"/>
                    </StackLayout>

                    <CollectionView ItemsSource="{Binding TiposCita}" 
                                    SelectedItem="{Binding TipoCitaSeleccionado}" 
                                    SelectionMode="Single">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border Margin="0,6" BackgroundColor="{StaticResource MedicalGray}" 
                                        Stroke="#E1E8ED" StrokeThickness="1"
                                        Padding="20">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="12"/>
                                    </Border.StrokeShape>
                                    <Border.Triggers>
                                        <DataTrigger TargetType="Border" 
                                                   Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.IdTipoCita}" 
                                                   Value="{Binding IdTipoCita}">
                                            <Setter Property="BackgroundColor" Value="#E8F4FD"/>
                                            <Setter Property="Stroke" Value="{StaticResource MedicalBlue}"/>
                                            <Setter Property="StrokeThickness" Value="2"/>
                                        </DataTrigger>
                                    </Border.Triggers>

                                    <StackLayout Spacing="10">
                                        <StackLayout Orientation="Horizontal" Spacing="15">
                                            <Label Text="{Binding IconoTipo}" FontSize="28" VerticalOptions="Center"/>
                                            <StackLayout VerticalOptions="Center">
                                                <Label Text="{Binding NombreTipo}" 
                                                       FontSize="18" 
                                                       FontAttributes="Bold" 
                                                       TextColor="{StaticResource TextDark}"/>
                                                <Label Text="{Binding Descripcion}" 
                                                       FontSize="14" 
                                                       TextColor="{StaticResource TextLight}"/>
                                            </StackLayout>
                                        </StackLayout>
                                    </StackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>
            </Border>

            <!-- PASO 2: BUSCAR/CREAR PACIENTE -->
            <Border IsVisible="{Binding TipoCitaSeleccionado, Converter={StaticResource ObjectToBoolConverter}}"
                    BackgroundColor="{StaticResource MedicalWhite}" 
                    Stroke="Transparent" StrokeThickness="0"
                    Padding="25">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.08" Radius="12" Offset="0,4"/>
                </Border.Shadow>

                <StackLayout Spacing="20">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Border BackgroundColor="{StaticResource AccentGreen}"
                                WidthRequest="35" HeightRequest="35">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="17" />
                            </Border.StrokeShape>
                            <Label Text="2" FontSize="18" FontAttributes="Bold" 
                                   TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <Label Text="Identificar Paciente" 
                               FontSize="20" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"
                               VerticalOptions="Center"/>
                    </StackLayout>

                    <!-- BÃºsqueda por cÃ©dula mejorada -->
                    <StackLayout Spacing="12">
                        <Label Text="CÃ©dula del Paciente:" 
                               FontSize="16" FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"/>

                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                            <Border Grid.Column="0" BackgroundColor="{StaticResource MedicalGray}" 
                                    Stroke="#E1E8ED" StrokeThickness="1"
                                    Padding="15">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <Entry Text="{Binding CedulaBusqueda}"
                                       Placeholder="Ingrese nÃºmero de cÃ©dula (10 dÃ­gitos)"
                                       Keyboard="Numeric"
                                       MaxLength="10"
                                       BackgroundColor="Transparent"
                                       TextColor="{StaticResource TextDark}"
                                       PlaceholderColor="{StaticResource TextLight}"
                                       FontSize="16"/>
                            </Border>

                            <Button Grid.Column="1" Text="ðŸ” Buscar" 
                                    Command="{Binding BuscarPacienteCommand}"
                                    FontSize="15"
                                    FontAttributes="Bold"
                                    TextColor="White"
                                    WidthRequest="110"
                                    HeightRequest="50"
                                    CornerRadius="10">
                                <Button.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Color="{StaticResource AccentGreen}" Offset="0.0" />
                                        <GradientStop Color="#229954" Offset="1.0" />
                                    </LinearGradientBrush>
                                </Button.Background>
                            </Button>
                        </Grid>
                    </StackLayout>

                    <!-- Paciente encontrado -->
                    <Border IsVisible="{Binding PacienteEncontrado}" 
                            BackgroundColor="#E8F5E8" 
                            Stroke="{StaticResource AccentGreen}" 
                            StrokeThickness="2"
                            Padding="20">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <StackLayout IsVisible="{Binding PacienteSeleccionado, Converter={StaticResource ObjectToBoolConverter}}" 
                                     Spacing="8">
                            <Label Text="âœ… Paciente Encontrado" 
                                   FontSize="16" FontAttributes="Bold" 
                                   TextColor="#2E7D32"/>
                            <Label Text="{Binding PacienteSeleccionado.NombreCompleto}" 
                                   FontSize="18" FontAttributes="Bold" 
                                   TextColor="{StaticResource TextDark}"/>
                            <Label Text="{Binding PacienteSeleccionado.Correo, StringFormat='ðŸ“§ {0}'}" 
                                   TextColor="{StaticResource TextLight}" FontSize="14"/>
                            <Label Text="{Binding PacienteSeleccionado.Telefono, StringFormat='ðŸ“± {0}'}" 
                                   TextColor="{StaticResource TextLight}" FontSize="14"/>
                            <Label Text="{Binding PacienteSeleccionado.FechaNacimiento, StringFormat='ðŸŽ‚ Nacimiento: {0:dd/MM/yyyy}'}" 
                                   TextColor="{StaticResource TextLight}" FontSize="14"/>
                        </StackLayout>
                    </Border>

                    <!-- Paciente no encontrado -->
                    <Border IsVisible="{Binding MostrarFormularioPaciente}" 
                            BackgroundColor="#FFF3E0" 
                            Stroke="{StaticResource MedicalGreen}" 
                            StrokeThickness="2"
                            Padding="20">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <StackLayout Spacing="15">
                            <Label Text="âš ï¸ Paciente No Encontrado" 
                                   FontSize="16" 
                                   FontAttributes="Bold" 
                                   TextColor="{StaticResource MedicalGreen}"/>
                            <Label Text="El paciente no estÃ¡ registrado en el sistema. Es necesario registrarlo primero." 
                                   FontSize="14" 
                                   TextColor="{StaticResource TextDark}"/>

                            <Button Text="âž• Registrar Nuevo Paciente" 
                                    Command="{Binding AbrirModalCrearPacienteCommand}"
                                    FontSize="16"
                                    FontAttributes="Bold"
                                    TextColor="White"
                                    HeightRequest="50"
                                    CornerRadius="12">
                                <Button.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Color="{StaticResource MedicalGreen}" Offset="0.0" />
                                        <GradientStop Color="#E67E22" Offset="1.0" />
                                    </LinearGradientBrush>
                                </Button.Background>
                            </Button>
                        </StackLayout>
                    </Border>
                </StackLayout>
            </Border>

            <!-- PASO 3: SELECCIÃ“N DE MÃ‰DICO -->
            <Border IsVisible="{Binding PacienteSeleccionado, Converter={StaticResource ObjectToBoolConverter}}"
                    BackgroundColor="{StaticResource MedicalWhite}" 
                    Stroke="Transparent" StrokeThickness="0"
                    Padding="25">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.08" Radius="12" Offset="0,4"/>
                </Border.Shadow>

                <StackLayout Spacing="20">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Border BackgroundColor="{StaticResource MedicalBlue}"
                                WidthRequest="35" HeightRequest="35">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="17" />
                            </Border.StrokeShape>
                            <Label Text="3" FontSize="18" FontAttributes="Bold" 
                                   TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <Label Text="Seleccionar MÃ©dico" 
                               FontSize="20" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"
                               VerticalOptions="Center"/>
                    </StackLayout>

                    <!-- SelecciÃ³n de Sucursal -->
                    <StackLayout Spacing="10">
                        <Label Text="ðŸ¥ Sucursal MÃ©dica:" 
                               FontSize="16" FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"/>
                        <Border BackgroundColor="{StaticResource MedicalGray}" 
                                Stroke="#E1E8ED" StrokeThickness="1"
                                Padding="15">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="10"/>
                            </Border.StrokeShape>
                            <Picker ItemsSource="{Binding Sucursales}" 
                                    SelectedItem="{Binding SucursalSeleccionada}"
                                    ItemDisplayBinding="{Binding Nombre}"
                                    Title="Seleccione una sucursal"
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource TextDark}"
                                    TitleColor="{StaticResource TextLight}"
                                    FontSize="16"/>
                        </Border>
                    </StackLayout>

                    <!-- SelecciÃ³n de Especialidad -->
                    <StackLayout Spacing="10">
                        <Label Text="ðŸ©º Especialidad MÃ©dica:" 
                               FontSize="16" FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"/>
                        <Border BackgroundColor="{StaticResource MedicalGray}" 
                                Stroke="#E1E8ED" StrokeThickness="1"
                                Padding="15">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="10"/>
                            </Border.StrokeShape>
                            <Picker ItemsSource="{Binding Especialidades}" 
                                    SelectedItem="{Binding EspecialidadSeleccionada}"
                                    ItemDisplayBinding="{Binding Nombre}"
                                    Title="Seleccione una especialidad"
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource TextDark}"
                                    TitleColor="{StaticResource TextLight}"
                                    FontSize="16"
                                    IsEnabled="{Binding SucursalSeleccionada, Converter={StaticResource ObjectToBoolConverter}}"/>
                        </Border>

                        <Label Text="{Binding Especialidades.Count, StringFormat='âœ… {0} especialidades disponibles'}" 
                               FontSize="13" 
                               TextColor="{StaticResource AccentGreen}"
                               FontAttributes="Bold" />
                    </StackLayout>

                    <!-- SelecciÃ³n de Doctor -->
                    <StackLayout Spacing="12">
                        <Label Text="ðŸ‘¨â€âš•ï¸ Doctor Especialista:" 
                               FontSize="16" FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"/>

                        <CollectionView ItemsSource="{Binding Doctores}" 
                                        SelectedItem="{Binding DoctorSeleccionado}" 
                                        SelectionMode="Single"
                                        IsVisible="{Binding Doctores.Count, Converter={StaticResource CountToBoolConverter}}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="0,6" BackgroundColor="{StaticResource MedicalGray}" 
                                            Stroke="#E1E8ED" StrokeThickness="1"
                                            Padding="18">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12"/>
                                        </Border.StrokeShape>
                                        <Border.Triggers>
                                            <DataTrigger TargetType="Border" 
                                                       Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.IdDoctor}" 
                                                       Value="{Binding IdDoctor}">
                                                <Setter Property="BackgroundColor" Value="#E8F4FD"/>
                                                <Setter Property="Stroke" Value="{StaticResource MedicalBlue}"/>
                                                <Setter Property="StrokeThickness" Value="2"/>
                                            </DataTrigger>
                                        </Border.Triggers>

                                        <StackLayout Orientation="Horizontal" Spacing="15">
                                            <Border BackgroundColor="{StaticResource MedicalBlue}" 
                                                    WidthRequest="55" HeightRequest="55" 
                                                    StrokeThickness="0"
                                                    VerticalOptions="Center">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="27"/>
                                                </Border.StrokeShape>
                                                <Label Text="ðŸ‘¨â€âš•ï¸" 
                                                       FontSize="24" 
                                                       HorizontalOptions="Center" 
                                                       VerticalOptions="Center"/>
                                            </Border>
                                            <StackLayout VerticalOptions="Center" Spacing="4">
                                                <Label Text="{Binding Nombres, StringFormat='Dr. {0}'}" 
                                                       FontSize="17" 
                                                       FontAttributes="Bold" 
                                                       TextColor="{StaticResource TextDark}"/>
                                                <Label Text="{Binding Apellidos}" 
                                                       FontSize="15" 
                                                       TextColor="{StaticResource TextLight}"/>
                                                <Label Text="{Binding TituloProfesional}" 
                                                       FontSize="13" 
                                                       TextColor="{StaticResource MedicalBlue}"
                                                       FontAttributes="Bold"/>
                                            </StackLayout>
                                        </StackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <!-- Mensaje cuando no hay doctores -->
                        <Border BackgroundColor="#FFF3E0" 
                                Stroke="{StaticResource MedicalGreen}" 
                                StrokeThickness="1"
                                Padding="20"
                                IsVisible="{Binding Doctores.Count, Converter={StaticResource CountToInverseBoolConverter}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <Label Text="âš ï¸ No hay doctores disponibles para esta especialidad y sucursal" 
                                   FontSize="15" 
                                   TextColor="{StaticResource MedicalGreen}"
                                   FontAttributes="Bold"
                                   HorizontalOptions="Center" />
                        </Border>
                    </StackLayout>
                </StackLayout>
            </Border>

            <!-- PASO 4: CALENDARIO Y HORARIOS -->
            <Border IsVisible="{Binding DoctorSeleccionado, Converter={StaticResource ObjectToBoolConverter}}"
                    BackgroundColor="{StaticResource MedicalWhite}" 
                    Stroke="Transparent" StrokeThickness="0"
                    Padding="25">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.08" Radius="12" Offset="0,4"/>
                </Border.Shadow>

                <StackLayout Spacing="20">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Border BackgroundColor="{StaticResource AccentRed}"
                                WidthRequest="35" HeightRequest="35">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="17" />
                            </Border.StrokeShape>
                            <Label Text="4" FontSize="18" FontAttributes="Bold" 
                                   TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <Label Text="Seleccionar Fecha y Hora" 
                               FontSize="20" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"
                               VerticalOptions="Center"/>
                    </StackLayout>

                    <!-- NavegaciÃ³n de semana mejorada -->
                    <Border BackgroundColor="{StaticResource MedicalGray}" 
                            Stroke="#E1E8ED" StrokeThickness="1" 
                            Padding="15">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">
                            <Button Grid.Column="0" Text="â—€" 
                                   Command="{Binding SemanaAnteriorCommand}"
                                   BackgroundColor="{StaticResource MedicalBlue}" 
                                   TextColor="White" 
                                   WidthRequest="45" 
                                   HeightRequest="45"
                                   FontSize="18"
                                   CornerRadius="22"/>
                            <Label Grid.Column="1" Text="{Binding TituloSemana}" 
                                  FontSize="17" 
                                  FontAttributes="Bold" 
                                  VerticalOptions="Center" 
                                  HorizontalOptions="Center"
                                  TextColor="{StaticResource TextDark}"/>
                            <Button Grid.Column="2" Text="â–¶" 
                                   Command="{Binding SemanaSiguienteCommand}"
                                   BackgroundColor="{StaticResource MedicalBlue}" 
                                   TextColor="White" 
                                   WidthRequest="45" 
                                   HeightRequest="45"
                                   FontSize="18"
                                   CornerRadius="22"/>
                        </Grid>
                    </Border>

                    <!-- Calendario de horarios disponibles -->
                    <StackLayout Spacing="12">
                        <Label Text="ðŸ“… Horarios Disponibles:" 
                               FontSize="16" FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"/>

                        <CollectionView ItemsSource="{Binding SlotsDisponibles}" 
                                       SelectedItem="{Binding SlotSeleccionado}" 
                                       SelectionMode="Single">
                            <CollectionView.ItemsLayout>
                                <GridItemsLayout Orientation="Vertical" 
                                              Span="3" 
                                              VerticalItemSpacing="10" 
                                              HorizontalItemSpacing="10"/>
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border BackgroundColor="{StaticResource MedicalGray}" 
                                           Stroke="#E1E8ED"
                                           StrokeThickness="1"
                                           HeightRequest="75">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="10"/>
                                        </Border.StrokeShape>
                                        <Border.Triggers>
                                            <DataTrigger TargetType="Border" 
                                                       Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.FechaHora}" 
                                                       Value="{Binding FechaHora}">
                                                <Setter Property="BackgroundColor" Value="{StaticResource MedicalBlue}"/>
                                                <Setter Property="Stroke" Value="{StaticResource MedicalBlue}"/>
                                                <Setter Property="StrokeThickness" Value="2"/>
                                            </DataTrigger>
                                            <DataTrigger TargetType="Border" Binding="{Binding Disponible}" Value="False">
                                                <Setter Property="BackgroundColor" Value="#FFEBEE"/>
                                                <Setter Property="Stroke" Value="{StaticResource AccentRed}"/>
                                                <Setter Property="Opacity" Value="0.6"/>
                                            </DataTrigger>
                                        </Border.Triggers>

                                        <StackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="3">
                                            <Label Text="{Binding Fecha, StringFormat='{0:dd/MM}'}" 
                                                  FontSize="12" 
                                                  FontAttributes="Bold" 
                                                  HorizontalOptions="Center"
                                                  TextColor="{StaticResource TextDark}">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label" 
                                                               Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.FechaHora}" 
                                                               Value="{Binding FechaHora}">
                                                        <Setter Property="TextColor" Value="White"/>
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                            <Label Text="{Binding Hora}" 
                                                  FontSize="14" 
                                                  FontAttributes="Bold" 
                                                  HorizontalOptions="Center"
                                                  TextColor="{StaticResource TextDark}">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label" 
                                                               Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.FechaHora}" 
                                                               Value="{Binding FechaHora}">
                                                        <Setter Property="TextColor" Value="White"/>
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                            <Label FontSize="10" 
                                                   TextColor="{StaticResource AccentGreen}"
                                                   FontAttributes="Bold"
                                                   HorizontalOptions="Center">
                                                <Label.Text>
                                                    <Binding Path="Disponible">
                                                        <Binding.Converter>
                                                            <local2:BoolToAvailabilityTextConverter/>
                                                        </Binding.Converter>
                                                    </Binding>
                                                </Label.Text>
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label" Binding="{Binding Disponible}" Value="False">
                                                        <Setter Property="TextColor" Value="{StaticResource AccentRed}"/>
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="Label" 
                                                               Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem.FechaHora}" 
                                                               Value="{Binding FechaHora}">
                                                        <Setter Property="TextColor" Value="White"/>
                                                        <Setter Property="Opacity" Value="0.9"/>
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                        </StackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>

                    <!-- Detalles de la cita -->
                    <StackLayout IsVisible="{Binding SlotSeleccionado, Converter={StaticResource ObjectToBoolConverter}}" 
                                 Spacing="15">
                        <Label Text="ðŸ“ Detalles de la Cita" 
                               FontSize="18" FontAttributes="Bold" 
                               TextColor="{StaticResource TextDark}"/>

                        <StackLayout Spacing="8">
                            <Label Text="Motivo de la consulta *:" 
                                   FontSize="15" FontAttributes="Bold" 
                                   TextColor="{StaticResource TextDark}"/>
                            <Border BackgroundColor="{StaticResource MedicalGray}" 
                                    Stroke="#E1E8ED" StrokeThickness="1"
                                    Padding="15">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <Entry Text="{Binding MotivoCita}" 
                                      Placeholder="Describa el motivo de la consulta mÃ©dica"
                                      BackgroundColor="Transparent"
                                      TextColor="{StaticResource TextDark}"
                                      PlaceholderColor="{StaticResource TextLight}"
                                      FontSize="16"
                                      HeightRequest="45"/>
                            </Border>
                        </StackLayout>

                        <StackLayout Spacing="8">
                            <Label Text="Notas adicionales:" 
                                   FontSize="15" FontAttributes="Bold" 
                                   TextColor="{StaticResource TextDark}"/>
                            <Border BackgroundColor="{StaticResource MedicalGray}" 
                                    Stroke="#E1E8ED" StrokeThickness="1"
                                    Padding="15">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <Editor Text="{Binding NotasCita}" 
                                       Placeholder="InformaciÃ³n adicional para el mÃ©dico (opcional)"
                                       BackgroundColor="Transparent"
                                       TextColor="{StaticResource TextDark}"
                                       PlaceholderColor="{StaticResource TextLight}"
                                       FontSize="15"
                                       HeightRequest="70"/>
                            </Border>
                        </StackLayout>
                    </StackLayout>

                    <!-- Resumen final profesional -->
                    <Border IsVisible="{Binding SlotSeleccionado, Converter={StaticResource ObjectToBoolConverter}}" 
                           BackgroundColor="#E8F5E8" 
                           Stroke="{StaticResource AccentGreen}" 
                           StrokeThickness="2"
                           Padding="20">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="15"/>
                        </Border.StrokeShape>
                        <StackLayout Spacing="10">
                            <Label Text="ðŸ“‹ Resumen de la Cita MÃ©dica" 
                                   FontSize="17" FontAttributes="Bold" 
                                   TextColor="#2E7D32"/>
                            <Label Text="{Binding PacienteSeleccionado.NombreCompleto, StringFormat='ðŸ‘¤ Paciente: {0}'}" 
                                  TextColor="{StaticResource TextDark}" FontSize="14"/>
                            <Label Text="{Binding DoctorSeleccionado.NombreCompleto, StringFormat='ðŸ‘¨â€âš•ï¸ Doctor: Dr. {0}'}" 
                                  TextColor="{StaticResource TextDark}" FontSize="14"/>
                            <Label Text="{Binding SucursalSeleccionada.Nombre, StringFormat='ðŸ¥ Sucursal: {0}'}" 
                                  TextColor="{StaticResource TextDark}" FontSize="14"/>
                            <Label Text="{Binding SlotSeleccionado.FechaHora, StringFormat='ðŸ“… Fecha: {0:dd/MM/yyyy HH:mm}'}" 
                                  TextColor="{StaticResource TextDark}" FontSize="14"/>
                            <Label Text="{Binding TipoCitaSeleccionado.NombreTipo, StringFormat='ðŸ“‹ Tipo: {0}'}" 
                                  TextColor="{StaticResource TextDark}" FontSize="14"/>
                        </StackLayout>
                    </Border>

                    <!-- BotÃ³n crear cita mejorado -->
                    <Button Text="âœ… Crear Cita MÃ©dica" 
                           Command="{Binding CrearCitaCommand}"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="White"
                           HeightRequest="55"
                           CornerRadius="15"
                           IsEnabled="{Binding PuedeCrearCita}">
                        <Button.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                <GradientStop Color="{StaticResource AccentGreen}" Offset="0.0" />
                                <GradientStop Color="#229954" Offset="1.0" />
                            </LinearGradientBrush>
                        </Button.Background>
                        <Button.Shadow>
                            <Shadow Brush="{StaticResource AccentGreen}" Opacity="0.4" Radius="10" Offset="0,4" />
                        </Button.Shadow>
                        <Button.Style>
                            <Style TargetType="Button">
                                <Style.Triggers>
                                    <Trigger TargetType="Button" Property="IsEnabled" Value="False">
                                        <Setter Property="BackgroundColor" Value="#BDBDBD"/>
                                        <Setter Property="Shadow" Value="{x:Null}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackLayout>
            </Border>

            <!-- Loading Indicator mÃ©dico -->
            <Border IsVisible="{Binding IsLoading}" 
                    BackgroundColor="{StaticResource MedicalWhite}"
                    Stroke="Transparent"
                    Padding="30">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.1" Radius="15" Offset="0,5"/>
                </Border.Shadow>

                <StackLayout HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Spacing="15">
                    <ActivityIndicator IsRunning="{Binding IsLoading}" 
                                     Color="{StaticResource MedicalBlue}" 
                                     WidthRequest="50"
                                     HeightRequest="50"/>
                    <Label Text="Procesando cita mÃ©dica..." 
                          FontSize="16" 
                          FontAttributes="Bold"
                          TextColor="{StaticResource TextDark}"
                          HorizontalOptions="Center"/>
                    <Label Text="Por favor espere un momento" 
                          FontSize="14" 
                          TextColor="{StaticResource TextLight}"
                          HorizontalOptions="Center"/>
                </StackLayout>
            </Border>

            <!-- BotÃ³n Cancelar mejorado -->
            <Button Text="âŒ Cancelar Proceso" 
                   Command="{Binding CancelarCommand}"
                   FontSize="16"
                   FontAttributes="Bold"
                   TextColor="White"
                   HeightRequest="50"
                   CornerRadius="12"
                   Margin="0,10,0,25">
                <Button.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                        <GradientStop Color="{StaticResource AccentRed}" Offset="0.0" />
                        <GradientStop Color="#C0392B" Offset="1.0" />
                    </LinearGradientBrush>
                </Button.Background>
            </Button>

        </StackLayout>
    </ScrollView>
</ContentPage>