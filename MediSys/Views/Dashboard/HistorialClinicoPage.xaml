<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MediSys.ViewModels"
             xmlns:models="clr-namespace:MediSys.Models"
             x:Class="MediSys.Views.Dashboard.HistorialClinicoPage"
             x:DataType="viewmodels:HistorialClinicoViewModel"
             xmlns:local2="clr-namespace:MediSys.Converters"
             Title="Historial Clínico"
             BackgroundColor="#F8FAFC">

    <ContentPage.Resources>
        <ResourceDictionary>

            <local2:BoolToTextConverter x:Key="BoolToTextConverter" />
            <local2:IsNotNullConverter x:Key="IsNotNullConverter" />
            <local2:BoolToColorConverter x:Key="BoolToColorConverter" />

            <!-- COLORES COMPACTOS -->
            <Color x:Key="PrimaryBlue">#2563EB</Color>
            <Color x:Key="SecondaryBlue">#3B82F6</Color>
            <Color x:Key="AccentTeal">#0D9488</Color>
            <Color x:Key="SuccessGreen">#059669</Color>
            <Color x:Key="WarningAmber">#D97706</Color>
            <Color x:Key="DangerRed">#DC2626</Color>
            <Color x:Key="CardWhite">#FFFFFF</Color>
            <Color x:Key="TextDark">#1F2937</Color>
            <Color x:Key="TextMedium">#6B7280</Color>
            <Color x:Key="TextLight">#9CA3AF</Color>
            <Color x:Key="BackgroundPale">#F9FAFB</Color>
            <Color x:Key="BorderSoft">#E5E7EB</Color>
            <Color x:Key="BorderDark">#374151</Color>

            <!-- ESTILOS COMPACTOS -->
            <Style x:Key="CompactCardStyle" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="{StaticResource CardWhite}" />
                <Setter Property="HasShadow" Value="True" />
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="Padding" Value="16" />
                <Setter Property="Margin" Value="12,6" />
                <Setter Property="BorderColor" Value="{StaticResource BorderSoft}" />
            </Style>

            <Style x:Key="SectionTitleStyle" TargetType="Label">
                <Setter Property="FontSize" Value="16" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{StaticResource PrimaryBlue}" />
                <Setter Property="Margin" Value="0,0,0,12" />
            </Style>

            <Style x:Key="CompactButtonStyle" TargetType="Button">
                <Setter Property="BackgroundColor" Value="{StaticResource PrimaryBlue}" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="CornerRadius" Value="8" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="14" />
                <Setter Property="HeightRequest" Value="40" />
            </Style>

            <Style x:Key="SecondaryCompactStyle" TargetType="Button">
                <Setter Property="BackgroundColor" Value="{StaticResource TextMedium}" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="CornerRadius" Value="8" />
                <Setter Property="FontSize" Value="12" />
                <Setter Property="HeightRequest" Value="36" />
            </Style>

        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <StackLayout Spacing="0" Padding="0,0,0,20">

            <!-- HEADER COMPACTO -->
            <Frame BackgroundColor="{StaticResource PrimaryBlue}"
                  HasShadow="True" 
                    Padding="20,16,20,16"
                    Margin="18,12,18,12"
                    CornerRadius="12"
                    HorizontalOptions="FillAndExpand">
                <StackLayout Spacing="8">
                    <Label Text="📋 Historial Clínico Digital" 
                           FontSize="20" 
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalOptions="Center" />
                    <Label Text="Búsqueda rápida de expedientes médicos" 
                           FontSize="13" 
                           TextColor="#DBEAFE"
                           HorizontalOptions="Center" />
                </StackLayout>
            </Frame>

            <!-- BÚSQUEDA COMPACTA -->
            <Frame Style="{StaticResource CompactCardStyle}">
                <StackLayout Spacing="16">

                    <Label Text="🔍 Búsqueda de Paciente" 
                           Style="{StaticResource SectionTitleStyle}" />

                    <StackLayout Spacing="8">
                        <Label Text="Cédula de Identidad" 
                               FontSize="13" 
                               FontAttributes="Bold"
                               TextColor="{StaticResource TextDark}" />

                        <Frame BackgroundColor="{StaticResource BackgroundPale}" 
                               CornerRadius="8" 
                               HasShadow="False" 
                               Padding="12">
                            <Entry Text="{Binding CedulaBusqueda}" 
                                   Placeholder="Ej: 1234567890"
                                   Keyboard="Numeric"
                                   BackgroundColor="Transparent"
                                   TextColor="{StaticResource TextDark}"
                                   FontSize="16"
                                   HeightRequest="40"
                                   MaxLength="10"
                                   ReturnCommand="{Binding BuscarHistorialCommand}" />
                        </Frame>
                    </StackLayout>

                    <Grid ColumnDefinitions="3*,*" ColumnSpacing="12">
                        <Button Grid.Column="0"
                                Text="🔍 Buscar Historial"
                                Command="{Binding BuscarHistorialCommand}"
                                Style="{StaticResource CompactButtonStyle}" />

                        <Button Grid.Column="1"
                                Text="{Binding ShowFilters, Converter={StaticResource BoolToTextConverter}, ConverterParameter='❌|⚙️'}"
                                Command="{Binding ToggleFiltersCommand}"
                                Style="{StaticResource SecondaryCompactStyle}" />
                    </Grid>

                    <!-- Indicador de carga compacto -->
                    <StackLayout IsVisible="{Binding IsLoading}" 
                                 Orientation="Horizontal" 
                                 HorizontalOptions="Center"
                                 Spacing="12">
                        <ActivityIndicator IsRunning="{Binding IsLoading}"
                                           Color="{StaticResource PrimaryBlue}"
                                           VerticalOptions="Center" />
                        <Label Text="Buscando información..."
                               FontSize="13"
                               TextColor="{StaticResource TextMedium}"
                               VerticalOptions="Center" />
                    </StackLayout>
                </StackLayout>
            </Frame>

            <!-- FILTROS COMPACTOS -->
            <Frame Style="{StaticResource CompactCardStyle}" 
                   IsVisible="{Binding ShowFilters}">
                <StackLayout Spacing="16">

                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <Label Grid.Column="0"
                               Text="⚙️ Filtros Avanzados" 
                               Style="{StaticResource SectionTitleStyle}"
                               VerticalOptions="Center" />

                        <Button Grid.Column="1"
                                Text="🗑️ Limpiar"
                                Command="{Binding LimpiarFiltrosCommand}"
                                BackgroundColor="{StaticResource DangerRed}"
                                TextColor="White"
                                CornerRadius="6"
                                FontSize="11"
                                HeightRequest="28"
                                Padding="12,0" />
                    </Grid>

                    <!-- Fechas compactas -->
                    <StackLayout Spacing="12">
                        <Label Text="📅 Período de Consultas" 
                               FontSize="13" 
                               FontAttributes="Bold"
                               TextColor="{StaticResource TextDark}" />

                        <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                            <Frame Grid.Column="0" 
                                   BackgroundColor="{StaticResource BackgroundPale}" 
                                   CornerRadius="8" 
                                   HasShadow="False" 
                                   Padding="8">
                                <StackLayout Spacing="4">
                                    <Label Text="Desde" 
                                           FontSize="11" 
                                           TextColor="{StaticResource TextMedium}" />
                                    <DatePicker Date="{Binding FechaDesde}" 
                                                TextColor="{StaticResource TextDark}"
                                                FontSize="13"
                                                BackgroundColor="Transparent"
                                                DateSelected="OnFechaDesdeChanged" />
                                </StackLayout>
                            </Frame>

                            <Frame Grid.Column="1" 
                                   BackgroundColor="{StaticResource BackgroundPale}" 
                                   CornerRadius="8" 
                                   HasShadow="False" 
                                   Padding="8">
                                <StackLayout Spacing="4">
                                    <Label Text="Hasta" 
                                           FontSize="11" 
                                           TextColor="{StaticResource TextMedium}" />
                                    <DatePicker Date="{Binding FechaHasta}" 
                                                TextColor="{StaticResource TextDark}"
                                                FontSize="13"
                                                BackgroundColor="Transparent"
                                                DateSelected="OnFechaHastaChanged" />
                                </StackLayout>
                            </Frame>
                        </Grid>
                    </StackLayout>

                    <!-- Filtros en línea compactos -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12" RowSpacing="12">

                        <Frame Grid.Column="0" 
                               BackgroundColor="{StaticResource BackgroundPale}" 
                               CornerRadius="8" 
                               HasShadow="False" 
                               Padding="8">
                            <StackLayout Spacing="4">
                                <Label Text="🏥 Especialidad" 
                                       FontSize="11" 
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource TextMedium}" />
                                <Picker ItemsSource="{Binding Especialidades}"
                                        ItemDisplayBinding="{Binding Nombre}"
                                        SelectedItem="{Binding EspecialidadSeleccionada}"
                                        Title="Todas"
                                        FontSize="12"
                                        TextColor="{StaticResource TextDark}"
                                        BackgroundColor="Transparent"
                                        SelectedIndexChanged="OnEspecialidadChanged" />
                            </StackLayout>
                        </Frame>

                        <Frame Grid.Column="1" 
                               BackgroundColor="{StaticResource BackgroundPale}" 
                               CornerRadius="8" 
                               HasShadow="False" 
                               Padding="8">
                            <StackLayout Spacing="4">
                                <Label Text="📋 Estado" 
                                       FontSize="11" 
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource TextMedium}" />
                                <Picker ItemsSource="{Binding Estados}"
                                        SelectedItem="{Binding EstadoSeleccionado}"
                                        Title="Todos"
                                        FontSize="12"
                                        TextColor="{StaticResource TextDark}"
                                        BackgroundColor="Transparent"
                                        SelectedIndexChanged="OnEstadoChanged" />
                            </StackLayout>
                        </Frame>

                        <!-- Doctor -->
                        <Frame Grid.Row="1" Grid.ColumnSpan="2" 
                               BackgroundColor="{StaticResource BackgroundPale}" 
                               CornerRadius="8" 
                               HasShadow="False" 
                               Padding="8"
                               IsVisible="{Binding EspecialidadSeleccionada, Converter={StaticResource IsNotNullConverter}}">
                            <StackLayout Spacing="4">
                                <Label Text="👨‍⚕️ Médico Especialista" 
                                       FontSize="11" 
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource TextMedium}" />
                                <Picker ItemsSource="{Binding Doctores}"
                                        ItemDisplayBinding="{Binding NombreCompleto}"
                                        SelectedItem="{Binding DoctorSeleccionado}"
                                        Title="Todos los médicos"
                                        FontSize="12"
                                        TextColor="{StaticResource TextDark}"
                                        BackgroundColor="Transparent"
                                        SelectedIndexChanged="OnDoctorChanged" />
                            </StackLayout>
                        </Frame>
                    </Grid>
                </StackLayout>
            </Frame>

            <!-- INFORMACIÓN DEL PACIENTE COMPACTA -->
            <Frame Style="{StaticResource CompactCardStyle}" 
                   IsVisible="{Binding ShowResults}">
                <StackLayout Spacing="16">

                    <Label Text="👤 Información del Paciente" 
                           Style="{StaticResource SectionTitleStyle}" />

                    <!-- Nombre destacado compacto -->
                    <Frame BackgroundColor="{StaticResource PrimaryBlue}" 
                           CornerRadius="8" 
                           HasShadow="False" 
                           Padding="12">
                        <Label Text="{Binding PacienteEncontrado.NombreCompleto}" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="White" 
                               HorizontalOptions="Center" />
                    </Frame>

                    <!-- Grid compacto de información -->
                    <Grid ColumnDefinitions="*,*" 
                          RowDefinitions="Auto,Auto,Auto" 
                          RowSpacing="8" 
                          ColumnSpacing="12">

                        <!-- Fila 1 -->
                        <StackLayout Grid.Row="0" Grid.Column="0" Spacing="2">
                            <Label Text="🆔 Cédula" 
                                   FontSize="11" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextMedium}" />
                            <Label Text="{Binding PacienteEncontrado.Cedula}" 
                                   FontSize="14" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextDark}" />
                        </StackLayout>

                        <StackLayout Grid.Row="0" Grid.Column="1" Spacing="2">
                            <Label Text="🎂 Edad" 
                                   FontSize="11" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextMedium}" />
                            <Label Text="{Binding PacienteEncontrado.Edad, StringFormat='{0} años'}" 
                                   FontSize="14" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextDark}" />
                        </StackLayout>

                        <!-- Fila 2 -->
                        <StackLayout Grid.Row="1" Grid.Column="0" Spacing="2">
                            <Label Text="🩸 Tipo Sangre" 
                                   FontSize="11" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource DangerRed}" />
                            <Label Text="{Binding PacienteEncontrado.TipoSangre}" 
                                   FontSize="14" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource DangerRed}" />
                        </StackLayout>

                        <StackLayout Grid.Row="1" Grid.Column="1" Spacing="2">
                            <Label Text="⚧ Sexo" 
                                   FontSize="11" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextMedium}" />
                            <Label Text="{Binding PacienteEncontrado.Sexo}" 
                                   FontSize="14" 
                                   TextColor="{StaticResource TextDark}" />
                        </StackLayout>

                        <!-- Fila 3 -->
                        <StackLayout Grid.Row="2" Grid.Column="0" Spacing="2">
                            <Label Text="📞 Teléfono" 
                                   FontSize="11" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextMedium}" />
                            <Label Text="{Binding PacienteEncontrado.Telefono}" 
                                   FontSize="13" 
                                   TextColor="{StaticResource TextDark}" />
                        </StackLayout>

                        <StackLayout Grid.Row="2" Grid.Column="1" Spacing="2">
                            <Label Text="🌍 Nacionalidad" 
                                   FontSize="11" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextMedium}" />
                            <Label Text="{Binding PacienteEncontrado.Nacionalidad}" 
                                   FontSize="13" 
                                   TextColor="{StaticResource TextDark}" />
                        </StackLayout>
                    </Grid>

                    <!-- Alergias compactas -->
                    <Frame BackgroundColor="#FEF2F2" 
                           CornerRadius="8" 
                           HasShadow="False" 
                           Padding="12"
                           IsVisible="{Binding PacienteEncontrado.Alergias, Converter={StaticResource IsNotNullConverter}}">
                        <StackLayout Spacing="6">
                            <Label Text="⚠️ ALERGIAS IMPORTANTES" 
                                   FontSize="12" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource DangerRed}" />
                            <Label Text="{Binding PacienteEncontrado.Alergias}" 
                                   FontSize="13" 
                                   TextColor="{StaticResource DangerRed}" 
                                   LineBreakMode="WordWrap" />
                        </StackLayout>
                    </Frame>
                </StackLayout>
            </Frame>

            <!-- ESTADÍSTICAS COMPACTAS -->
            <Frame Style="{StaticResource CompactCardStyle}" 
                   IsVisible="{Binding ShowResults}">
                <StackLayout Spacing="12">

                    <Label Text="📊 Resumen Estadístico" 
                           Style="{StaticResource SectionTitleStyle}" />

                    <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="8">
                        <!-- Total -->
                        <Frame Grid.Column="0" 
                               BackgroundColor="#EBF8FF" 
                               CornerRadius="8" 
                               HasShadow="False" 
                               Padding="8">
                            <StackLayout Spacing="2">
                                <Label Text="{Binding Estadisticas.TotalCitas}" 
                                       FontSize="18" 
                                       FontAttributes="Bold" 
                                       TextColor="{StaticResource SecondaryBlue}" 
                                       HorizontalOptions="Center" />
                                <Label Text="Total" 
                                       FontSize="10" 
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource SecondaryBlue}" 
                                       HorizontalOptions="Center" />
                            </StackLayout>
                        </Frame>

                        <!-- Completadas -->
                        <Frame Grid.Column="1" 
                               BackgroundColor="#ECFDF5" 
                               CornerRadius="8" 
                               HasShadow="False" 
                               Padding="8">
                            <StackLayout Spacing="2">
                                <Label Text="{Binding Estadisticas.CitasCompletadas}" 
                                       FontSize="18" 
                                       FontAttributes="Bold" 
                                       TextColor="{StaticResource SuccessGreen}" 
                                       HorizontalOptions="Center" />
                                <Label Text="OK" 
                                       FontSize="10" 
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource SuccessGreen}" 
                                       HorizontalOptions="Center" />
                            </StackLayout>
                        </Frame>

                        <!-- Pendientes -->
                        <Frame Grid.Column="2" 
                               BackgroundColor="#FFFBEB" 
                               CornerRadius="8" 
                               HasShadow="False" 
                               Padding="8">
                            <StackLayout Spacing="2">
                                <Label Text="{Binding Estadisticas.CitasPendientes}" 
                                       FontSize="18" 
                                       FontAttributes="Bold" 
                                       TextColor="{StaticResource WarningAmber}" 
                                       HorizontalOptions="Center" />
                                <Label Text="Pend." 
                                       FontSize="10" 
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource WarningAmber}" 
                                       HorizontalOptions="Center" />
                            </StackLayout>
                        </Frame>

                        <!-- Canceladas -->
                        <Frame Grid.Column="3" 
                               BackgroundColor="#FEF2F2" 
                               CornerRadius="8" 
                               HasShadow="False" 
                               Padding="8">
                            <StackLayout Spacing="2">
                                <Label Text="{Binding Estadisticas.CitasCanceladas}" 
                                       FontSize="18" 
                                       FontAttributes="Bold" 
                                       TextColor="{StaticResource DangerRed}" 
                                       HorizontalOptions="Center" />
                                <Label Text="Canc." 
                                       FontSize="10" 
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource DangerRed}" 
                                       HorizontalOptions="Center" />
                            </StackLayout>
                        </Frame>
                    </Grid>
                </StackLayout>
            </Frame>

            <!-- LISTA DE CITAS ELEGANTE CON BORDE Y MÁS INFORMACIÓN -->
            <Frame Style="{StaticResource CompactCardStyle}" 
       IsVisible="{Binding ShowResults}">
                <StackLayout Spacing="12">

                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <Label Grid.Column="0"
                   Text="📋 Historial de Consultas" 
                   Style="{StaticResource SectionTitleStyle}"
                   VerticalOptions="Center" />

                        <Label Grid.Column="1"
                   Text="{Binding Citas.Count, StringFormat='{0} registros'}" 
                   FontSize="11" 
                   FontAttributes="Bold"
                   TextColor="{StaticResource AccentTeal}"
                   VerticalOptions="Center" />
                    </Grid>

                    <CollectionView ItemsSource="{Binding Citas}"
                        ItemSizingStrategy="MeasureAllItems">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:CitaMedica">
                                <Grid Padding="0,0,0,10">
                                    <!-- FRAME CON BORDE NEGRO ELEGANTE Y MÁS INFO -->
                                    <Frame BackgroundColor="{StaticResource CardWhite}" 
                               CornerRadius="12" 
                               HasShadow="True" 
                               Padding="16"
                               Margin="0"
                               BorderColor="{StaticResource BorderDark}"
                               >

                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:HistorialClinicoViewModel}}, Path=VerDetalleCitaCommand}"
                                                      CommandParameter="{Binding .}" />
                                        </Frame.GestureRecognizers>

                                        <StackLayout Spacing="12">

                                            <!-- Header mejorado con fecha y estado -->
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                                <StackLayout Grid.Column="0" Spacing="3">
                                                    <Label Text="{Binding FechaHora, StringFormat='{0:dddd, dd MMMM yyyy}'}" 
                                               FontSize="15" 
                                               FontAttributes="Bold" 
                                               TextColor="{StaticResource PrimaryBlue}" />
                                                    <Label Text="{Binding FechaHora, StringFormat='{0:HH:mm}'}" 
                                               FontSize="13" 
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextMedium}" />
                                                </StackLayout>

                                                <Frame Grid.Column="1"
                                           BackgroundColor="{Binding EstadoColor}" 
                                           CornerRadius="12" 
                                           Padding="10,5"
                                           HasShadow="False">
                                                    <Label Text="{Binding Estado}" 
                                               FontSize="11" 
                                               FontAttributes="Bold" 
                                               TextColor="White" />
                                                </Frame>
                                            </Grid>

                                            <!-- Información del médico y sucursal -->
                                            <Frame BackgroundColor="{StaticResource BackgroundPale}" 
                                       CornerRadius="8" 
                                       HasShadow="False" 
                                       Padding="12">
                                                <StackLayout Spacing="4">
                                                    <StackLayout Orientation="Horizontal" Spacing="6">
                                                        <Label Text="👨‍⚕️" FontSize="14" />
                                                        <Label Text="{Binding DoctorCompleto}" 
                                                   FontSize="13" 
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource TextDark}" />
                                                    </StackLayout>
                                                    <StackLayout Orientation="Horizontal" Spacing="6">
                                                        <Label Text="🏥" FontSize="12" />
                                                        <Label Text="{Binding EspecialidadNombre}" 
                                                   FontSize="12" 
                                                   TextColor="{StaticResource SecondaryBlue}"
                                                   FontAttributes="Bold" />
                                                    </StackLayout>
                                                    <StackLayout Orientation="Horizontal" Spacing="6">
                                                        <Label Text="📍" FontSize="12" />
                                                        <Label Text="{Binding SucursalNombre}" 
                                                   FontSize="11" 
                                                   TextColor="{StaticResource TextMedium}" />
                                                    </StackLayout>
                                                </StackLayout>
                                            </Frame>

                                            <!-- Motivo de consulta -->
                                            <StackLayout Spacing="4" 
                                             IsVisible="{Binding MotivoConsulta, Converter={StaticResource IsNotNullConverter}}">
                                                <StackLayout Orientation="Horizontal" Spacing="6">
                                                    <Label Text="💬" FontSize="12" />
                                                    <Label Text="Motivo:" 
                                               FontSize="11" 
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextMedium}" />
                                                </StackLayout>
                                                <Label Text="{Binding MotivoConsulta}" 
                                           FontSize="12" 
                                           TextColor="{StaticResource TextDark}"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="2"
                                           Margin="18,0,0,0" />
                                            </StackLayout>

                                            <!-- Información médica si existe consulta -->
                                            <StackLayout Spacing="8" 
                                             IsVisible="{Binding TieneConsulta}">

                                                <!-- Diagnóstico -->
                                                <Frame BackgroundColor="#ECFDF5" 
                                           CornerRadius="8" 
                                           HasShadow="False" 
                                           Padding="10"
                                           IsVisible="{Binding Diagnostico, Converter={StaticResource IsNotNullConverter}}">
                                                    <StackLayout Spacing="4">
                                                        <StackLayout Orientation="Horizontal" Spacing="6">
                                                            <Label Text="🩺" FontSize="12" />
                                                            <Label Text="Diagnóstico:" 
                                                       FontSize="11" 
                                                       FontAttributes="Bold"
                                                       TextColor="{StaticResource SuccessGreen}" />
                                                        </StackLayout>
                                                        <Label Text="{Binding Diagnostico}" 
                                                   FontSize="12" 
                                                   TextColor="{StaticResource TextDark}"
                                                   LineBreakMode="TailTruncation"
                                                   MaxLines="2"
                                                   Margin="18,0,0,0" />
                                                    </StackLayout>
                                                </Frame>

                                                <!-- Tratamiento -->
                                                <Frame BackgroundColor="#FFFBEB" 
                                           CornerRadius="8" 
                                           HasShadow="False" 
                                           Padding="10"
                                           IsVisible="{Binding Tratamiento, Converter={StaticResource IsNotNullConverter}}">
                                                    <StackLayout Spacing="4">
                                                        <StackLayout Orientation="Horizontal" Spacing="6">
                                                            <Label Text="💊" FontSize="12" />
                                                            <Label Text="Tratamiento:" 
                                                       FontSize="11" 
                                                       FontAttributes="Bold"
                                                       TextColor="{StaticResource WarningAmber}" />
                                                        </StackLayout>
                                                        <Label Text="{Binding Tratamiento}" 
                                                   FontSize="12" 
                                                   TextColor="{StaticResource TextDark}"
                                                   LineBreakMode="TailTruncation"
                                                   MaxLines="2"
                                                   Margin="18,0,0,0" />
                                                    </StackLayout>
                                                </Frame>
                                            </StackLayout>

                                            <!-- Información de triaje si existe
                                            <Frame BackgroundColor="#FEF2F2" 
                                       CornerRadius="8" 
                                       HasShadow="False" 
                                       Padding="10"
                                       IsVisible="{Binding TieneTriaje}">
                                                <StackLayout Spacing="6">
                                                    <StackLayout Orientation="Horizontal" Spacing="6">
                                                        <Label Text="🚨" FontSize="12" />
                                                        <Label Text="Triaje Completado" 
                                                   FontSize="11" 
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource DangerRed}" />
                                                    </StackLayout>

                                                     Signos vitales compactos 
                                                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8" Margin="18,0,0,0">
                                                        <StackLayout Grid.Column="0" Spacing="2">
                                                            <Label Text="{Binding Temperatura, StringFormat='🌡️ {0}°C'}" 
                                                       FontSize="10" 
                                                       TextColor="{StaticResource TextDark}"
                                                       IsVisible="{Binding Temperatura, Converter={StaticResource IsNotNullConverter}}" />
                                                            <Label Text="{Binding PresionArterial, StringFormat='💓 {0}'}" 
                                                       FontSize="10" 
                                                       TextColor="{StaticResource TextDark}"
                                                       IsVisible="{Binding PresionArterial, Converter={StaticResource IsNotNullConverter}}" />
                                                        </StackLayout>
                                                        <StackLayout Grid.Column="1" Spacing="2">
                                                            <Label Text="{Binding FrecuenciaCardiaca, StringFormat='💗 {0} bpm'}" 
                                                       FontSize="10" 
                                                       TextColor="{StaticResource TextDark}"
                                                       IsVisible="{Binding FrecuenciaCardiaca, Converter={StaticResource IsNotNullConverter}}" />
                                                            <Label Text="{Binding Peso, StringFormat='⚖️ {0} kg'}" 
                                                       FontSize="10" 
                                                       TextColor="{StaticResource TextDark}"
                                                       IsVisible="{Binding Peso, Converter={StaticResource IsNotNullConverter}}" />
                                                        </StackLayout>
                                                    </Grid>
                                                </StackLayout>
                                            </Frame>
                                            -->

                                            <!-- Footer con indicadores y fecha de seguimiento -->
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                                <!-- Indicadores de proceso -->
                                                <StackLayout Grid.Column="0" 
                                                 Orientation="Horizontal" 
                                                 Spacing="12"
                                                 VerticalOptions="Center">
                                                    <StackLayout Orientation="Horizontal" Spacing="4">
                                                        <Label Text="🏥" FontSize="12" />
                                                        <Label Text="Triaje" 
                                                   FontSize="10"
                                                   FontAttributes="Bold"
                                                   TextColor="{Binding TieneTriaje, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#059669|#D1D5DB'}" />
                                                    </StackLayout>
                                                    <StackLayout Orientation="Horizontal" Spacing="4">
                                                        <Label Text="💊" FontSize="12" />
                                                        <Label Text="Consulta" 
                                                   FontSize="10"
                                                   FontAttributes="Bold"
                                                   TextColor="{Binding TieneConsulta, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#3B82F6|#D1D5DB'}" />
                                                    </StackLayout>
                                                </StackLayout>

                                              
                                            </Grid>

                                        </StackLayout>
                                    </Frame>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>

                        <CollectionView.EmptyView>
                            <StackLayout Spacing="16" 
                             Padding="20"
                             HorizontalOptions="Center">
                                <Label Text="📋" 
                           FontSize="40" 
                           HorizontalOptions="Center" 
                           TextColor="{StaticResource TextLight}" />
                                <Label Text="No se encontraron registros médicos"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="{StaticResource TextMedium}"
                           HorizontalOptions="Center" />
                                <Label Text="Intente ajustar los filtros o verificar la cédula"
                           FontSize="12"
                           TextColor="{StaticResource TextLight}"
                           HorizontalOptions="Center" />
                                <Button Text="🔄 Nueva Búsqueda"
                            Command="{Binding BuscarHistorialCommand}"
                            Style="{StaticResource SecondaryCompactStyle}"
                            HorizontalOptions="Center" />
                            </StackLayout>
                        </CollectionView.EmptyView>
                    </CollectionView>
                    
                </StackLayout>
            </Frame>
            <!-- ✅ AGREGAR AQUÍ LA PAGINACIÓN -->
            <!-- CONTROLES DE PAGINACIÓN MEJORADOS -->
            <Frame Style="{StaticResource CompactCardStyle}" 
       IsVisible="{Binding MostrarControlesPaginacion}"
       BackgroundColor="#FFFFFF"
       BorderColor="{StaticResource BorderSoft}">
                <StackLayout Spacing="20">

                    <!-- INFORMACIÓN DE PAGINACIÓN -->
                    <Label Text="{Binding TextoPaginacion}"
               FontSize="13"
               FontAttributes="Bold"
               TextColor="{StaticResource TextMedium}"
               HorizontalOptions="Center" />

                    <!-- CONTENEDOR CENTRADO PARA BOTONES -->
                    <StackLayout HorizontalOptions="Center">

                        <!-- GRID DE BOTONES ALINEADO -->
                        <Grid ColumnDefinitions="60,60,60,60" 
                  ColumnSpacing="8"
                  HorizontalOptions="Center">

                            <!-- PRIMERA PÁGINA -->
                            <Button Grid.Column="0"
                        Text="⏮"
                        FontSize="16"
                        FontAttributes="Bold"
                        BackgroundColor="{StaticResource PrimaryBlue}"
                        TextColor="White"
                        CornerRadius="6"
                        HeightRequest="42"
                        WidthRequest="56"
                        Command="{Binding IrPrimeraPaginaCommand}"
                        IsEnabled="{Binding TienePaginaAnterior}"
                        Opacity="{Binding TienePaginaAnterior, Converter={StaticResource BoolToTextConverter}, ConverterParameter='1.0|0.4'}" />

                            <!-- PÁGINA ANTERIOR -->
                            <Button Grid.Column="1"
                        Text="◀"
                        FontSize="16"
                        FontAttributes="Bold"
                        BackgroundColor="{StaticResource SecondaryBlue}"
                        TextColor="White"
                        CornerRadius="6"
                        HeightRequest="42"
                        WidthRequest="56"
                        Command="{Binding IrPaginaAnteriorCommand}"
                        IsEnabled="{Binding TienePaginaAnterior}"
                        Opacity="{Binding TienePaginaAnterior, Converter={StaticResource BoolToTextConverter}, ConverterParameter='1.0|0.4'}" />

                            <!-- PÁGINA SIGUIENTE -->
                            <Button Grid.Column="2"
                        Text="▶"
                        FontSize="16"
                        FontAttributes="Bold"
                        BackgroundColor="{StaticResource SecondaryBlue}"
                        TextColor="White"
                        CornerRadius="6"
                        HeightRequest="42"
                        WidthRequest="56"
                        Command="{Binding IrPaginaSiguienteCommand}"
                        IsEnabled="{Binding TienePaginaSiguiente}"
                        Opacity="{Binding TienePaginaSiguiente, Converter={StaticResource BoolToTextConverter}, ConverterParameter='1.0|0.4'}" />

                            <!-- ÚLTIMA PÁGINA -->
                            <Button Grid.Column="3"
                        Text="⏭"
                        FontSize="16"
                        FontAttributes="Bold"
                        BackgroundColor="{StaticResource PrimaryBlue}"
                        TextColor="White"
                        CornerRadius="6"
                        HeightRequest="42"
                        WidthRequest="56"
                        Command="{Binding IrUltimaPaginaCommand}"
                        IsEnabled="{Binding TienePaginaSiguiente}"
                        Opacity="{Binding TienePaginaSiguiente, Converter={StaticResource BoolToTextConverter}, ConverterParameter='1.0|0.4'}" />
                        </Grid>

                    </StackLayout>

                    <!-- INDICADOR DE CARGA CON MEJOR DISEÑO -->
                    <Frame BackgroundColor="#F0F9FF" 
               CornerRadius="8" 
               HasShadow="False" 
               Padding="12"
               IsVisible="{Binding IsLoading}"
               HorizontalOptions="Center">
                        <StackLayout Orientation="Horizontal" 
                         Spacing="10">
                            <ActivityIndicator IsRunning="{Binding IsLoading}"
                                  Color="{StaticResource PrimaryBlue}"
                                  HeightRequest="24"
                                  WidthRequest="24" />
                            <Label Text="Cargando página..."
                       FontSize="13"
                       FontAttributes="Bold"
                       TextColor="{StaticResource PrimaryBlue}"
                       VerticalOptions="Center" />
                        </StackLayout>
                    </Frame>

                </StackLayout>
            </Frame>

        </StackLayout>
    </ScrollView>
</ContentPage>