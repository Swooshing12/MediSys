<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MediSys.ViewModels"
             xmlns:models="clr-namespace:MediSys.Models"
             x:Class="MediSys.Views.Dashboard.HistorialClinicoPage"
             x:DataType="viewmodels:HistorialClinicoViewModel"
             Title="Historial Clínico"
             BackgroundColor="#F5F7FA">

    <ScrollView>
        <StackLayout Padding="15" Spacing="15">

            <!-- HEADER -->
            <Frame BackgroundColor="White" 
                   CornerRadius="12" 
                   HasShadow="True" 
                   Padding="20"
                   Margin="0,5,0,0">
                <StackLayout Spacing="8">
                    <Label Text="Consultar Historial Clínico" 
                           FontSize="22" 
                           FontAttributes="Bold" 
                           TextColor="#2C3E50" 
                           HorizontalOptions="Center" />

                    <Label Text="Ingrese la cédula del paciente para consultar su historial médico completo" 
                           FontSize="14" 
                           TextColor="#7F8C8D" 
                           HorizontalOptions="Center" 
                           HorizontalTextAlignment="Center" />
                </StackLayout>
            </Frame>

            <!-- BÚSQUEDA -->
            <Frame BackgroundColor="White" 
                   CornerRadius="12" 
                   HasShadow="True" 
                   Padding="20">
                <StackLayout Spacing="15">

                    <Label Text="Cédula del Paciente" 
                           FontSize="16" 
                           FontAttributes="Bold" 
                           TextColor="#2C3E50" />

                    <Border BackgroundColor="White" 
                            Stroke="#3498DB" 
                            StrokeThickness="2" 
                            Padding="12">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8" />
                        </Border.StrokeShape>
                        <Entry Text="{Binding CedulaBusqueda}" 
                               Placeholder="Ej: 1234567890"
                               Keyboard="Numeric"
                               BackgroundColor="Transparent"
                               TextColor="#2C3E50"
                               FontSize="16"
                               PlaceholderColor="#BDC3C7" />
                    </Border>

                    <Grid ColumnDefinitions="2*,*" ColumnSpacing="10">
                        <Button Grid.Column="0"
                                Text="Buscar Historial"
                                BackgroundColor="#3498DB"
                                TextColor="White"
                                FontAttributes="Bold"
                                FontSize="16"
                                CornerRadius="8"
                                HeightRequest="50"
                                Command="{Binding BuscarHistorialCommand}" />

                        <Button Grid.Column="1"
                                Text="Filtros"
                                BackgroundColor="#95A5A6"
                                TextColor="White"
                                FontAttributes="Bold"
                                FontSize="14"
                                CornerRadius="8"
                                HeightRequest="50"
                                Command="{Binding ToggleFiltersCommand}" />
                    </Grid>

                    <ActivityIndicator IsVisible="{Binding IsLoading}" 
                                       IsRunning="{Binding IsLoading}"
                                       Color="#3498DB"
                                       HeightRequest="40" />
                </StackLayout>
            </Frame>

            <!-- FILTROS -->
            <Frame BackgroundColor="White" 
                   CornerRadius="12" 
                   HasShadow="True" 
                   Padding="20"
                   IsVisible="{Binding ShowFilters}">
                <StackLayout Spacing="15">

                    <Label Text="Filtros de Búsqueda" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#2C3E50" />

                    <!-- Fechas -->
                    <StackLayout Spacing="10">
                        <Label Text="Rango de Fechas" 
                               FontSize="14" 
                               FontAttributes="Bold"
                               TextColor="#34495E" />

                        <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                            <StackLayout Grid.Column="0">
                                <Label Text="Desde" 
                                       FontSize="12" 
                                       TextColor="#7F8C8D" />
                                <Border BackgroundColor="White" 
                                        Stroke="#BDC3C7" 
                                        StrokeThickness="1" 
                                        Padding="10">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="6" />
                                    </Border.StrokeShape>
                                    <DatePicker Date="{Binding FechaDesde}" 
                                                TextColor="#2C3E50"
                                                FontSize="14"
                                                BackgroundColor="Transparent" />
                                </Border>
                            </StackLayout>

                            <StackLayout Grid.Column="1">
                                <Label Text="Hasta" 
                                       FontSize="12" 
                                       TextColor="#7F8C8D" />
                                <Border BackgroundColor="White" 
                                        Stroke="#BDC3C7" 
                                        StrokeThickness="1" 
                                        Padding="10">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="6" />
                                    </Border.StrokeShape>
                                    <DatePicker Date="{Binding FechaHasta}" 
                                                TextColor="#2C3E50"
                                                FontSize="14"
                                                BackgroundColor="Transparent" />
                                </Border>
                            </StackLayout>
                        </Grid>
                    </StackLayout>

                    <!-- Especialidad -->
                    <!-- ESPECIALIDAD CON MEJOR CONTRASTE -->
                    <StackLayout Spacing="5">
                        <Label Text="Especialidad Médica" 
           FontSize="14" 
           FontAttributes="Bold"
           TextColor="#2C3E50" />

                        <Border BackgroundColor="White" 
            Stroke="#3498DB" 
            StrokeThickness="1" 
            Padding="5">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="6" />
                            </Border.StrokeShape>
                            <Picker ItemsSource="{Binding Especialidades}"
                ItemDisplayBinding="{Binding Nombre}"
                SelectedItem="{Binding EspecialidadSeleccionada}"
                Title="-- Seleccione especialidad --"
                FontSize="14"
                SelectedIndexChanged="OnEspecialidadChanged">
                                <Picker.TextColor>
                                    <OnPlatform x:TypeArguments="Color">
                                        <On Platform="Android" Value="#2C3E50" />
                                        <On Platform="iOS" Value="#2C3E50" />
                                        <On Platform="WinUI" Value="#2C3E50" />
                                    </OnPlatform>
                                </Picker.TextColor>
                                <Picker.BackgroundColor>
                                    <OnPlatform x:TypeArguments="Color">
                                        <On Platform="Android" Value="White" />
                                        <On Platform="iOS" Value="White" />
                                        <On Platform="WinUI" Value="White" />
                                    </OnPlatform>
                                </Picker.BackgroundColor>
                            </Picker>
                        </Border>
                    </StackLayout>
                    <!-- Doctor -->
                    <StackLayout Spacing="5" IsVisible="{Binding EspecialidadSeleccionada, Converter={StaticResource IsNotNullConverter}}">
                        <Label Text="Médico Especialista" 
                               FontSize="14" 
                               FontAttributes="Bold"
                               TextColor="#34495E" />
                        <Border BackgroundColor="White" 
                                Stroke="#BDC3C7" 
                                StrokeThickness="1" 
                                Padding="10">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="6" />
                            </Border.StrokeShape>
                            <Picker ItemsSource="{Binding Doctores}"
                                    ItemDisplayBinding="{Binding NombreCompleto}"
                                    SelectedItem="{Binding DoctorSeleccionado}"
                                    Title="Seleccione un médico"
                                    TextColor="#2C3E50"
                                    TitleColor="#7F8C8D"
                                    FontSize="14"
                                    BackgroundColor="Transparent" />
                        </Border>
                    </StackLayout>

                    <!-- Estado y Sucursal -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                        <StackLayout Grid.Column="0" Spacing="5">
                            <Label Text="Estado de Cita" 
                                   FontSize="14" 
                                   FontAttributes="Bold"
                                   TextColor="#34495E" />
                            <Border BackgroundColor="White" 
                                    Stroke="#BDC3C7" 
                                    StrokeThickness="1" 
                                    Padding="10">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="6" />
                                </Border.StrokeShape>
                                <Picker ItemsSource="{Binding Estados}"
                                        SelectedItem="{Binding EstadoSeleccionado}"
                                        Title="Todos"
                                        TextColor="#2C3E50"
                                        TitleColor="#7F8C8D"
                                        FontSize="14"
                                        BackgroundColor="Transparent" />
                            </Border>
                        </StackLayout>

                        <StackLayout Grid.Column="1" Spacing="5">
                            <Label Text="Sucursal" 
                                   FontSize="14" 
                                   FontAttributes="Bold"
                                   TextColor="#34495E" />
                            <Border BackgroundColor="White" 
                                    Stroke="#BDC3C7" 
                                    StrokeThickness="1" 
                                    Padding="10">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="6" />
                                </Border.StrokeShape>
                                <Picker ItemsSource="{Binding Sucursales}"
                                        ItemDisplayBinding="{Binding Nombre}"
                                        SelectedItem="{Binding SucursalSeleccionada}"
                                        Title="Todas"
                                        TextColor="#2C3E50"
                                        TitleColor="#7F8C8D"
                                        FontSize="14"
                                        BackgroundColor="Transparent" />
                            </Border>
                        </StackLayout>
                    </Grid>

                    <Button Text="Limpiar Filtros"
                            BackgroundColor="#E74C3C"
                            TextColor="White"
                            FontAttributes="Bold"
                            FontSize="14"
                            CornerRadius="8"
                            HeightRequest="45"
                            Command="{Binding LimpiarFiltrosCommand}" />
                </StackLayout>
            </Frame>

            <!-- INFORMACIÓN DEL PACIENTE -->
            <Frame BackgroundColor="White" 
                   CornerRadius="12" 
                   HasShadow="True" 
                   Padding="20"
                   IsVisible="{Binding ShowResults}">
                <StackLayout Spacing="15">

                    <Label Text="Información del Paciente" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#2C3E50" />

                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="10" ColumnSpacing="20">

                        <StackLayout Grid.Row="0" Grid.Column="0">
                            <Label Text="Nombre Completo" FontSize="12" TextColor="#7F8C8D" FontAttributes="Bold" />
                            <Label Text="{Binding PacienteEncontrado.NombreCompleto}" FontSize="14" TextColor="#2C3E50" FontAttributes="Bold" />
                        </StackLayout>

                        <StackLayout Grid.Row="0" Grid.Column="1">
                            <Label Text="Cédula" FontSize="12" TextColor="#7F8C8D" FontAttributes="Bold" />
                            <Label Text="{Binding PacienteEncontrado.Cedula}" FontSize="14" TextColor="#2C3E50" />
                        </StackLayout>

                        <StackLayout Grid.Row="1" Grid.Column="0">
                            <Label Text="Edad" FontSize="12" TextColor="#7F8C8D" FontAttributes="Bold" />
                            <Label Text="{Binding PacienteEncontrado.Edad, StringFormat='{0} años'}" FontSize="14" TextColor="#2C3E50" />
                        </StackLayout>

                        <StackLayout Grid.Row="1" Grid.Column="1">
                            <Label Text="Sexo" FontSize="12" TextColor="#7F8C8D" FontAttributes="Bold" />
                            <Label Text="{Binding PacienteEncontrado.Sexo}" FontSize="14" TextColor="#2C3E50" />
                        </StackLayout>

                        <StackLayout Grid.Row="2" Grid.Column="0">
                            <Label Text="Tipo de Sangre" FontSize="12" TextColor="#7F8C8D" FontAttributes="Bold" />
                            <Label Text="{Binding PacienteEncontrado.TipoSangre}" FontSize="14" TextColor="#E74C3C" FontAttributes="Bold" />
                        </StackLayout>

                        <StackLayout Grid.Row="2" Grid.Column="1">
                            <Label Text="Teléfono" FontSize="12" TextColor="#7F8C8D" FontAttributes="Bold" />
                            <Label Text="{Binding PacienteEncontrado.Telefono}" FontSize="14" TextColor="#2C3E50" />
                        </StackLayout>
                    </Grid>

                    <!-- Alergias y Antecedentes -->
                    <StackLayout Spacing="10" IsVisible="{Binding PacienteEncontrado.Alergias, Converter={StaticResource IsNotNullConverter}}">
                        <Label Text="Alergias" FontSize="12" TextColor="#E74C3C" FontAttributes="Bold" />
                        <Frame BackgroundColor="#FDF2F2" CornerRadius="8" Padding="10" HasShadow="False">
                            <Label Text="{Binding PacienteEncontrado.Alergias}" FontSize="13" TextColor="#E74C3C" LineBreakMode="WordWrap" />
                        </Frame>
                    </StackLayout>

                    <StackLayout Spacing="10" IsVisible="{Binding PacienteEncontrado.AntecedentesMedicos, Converter={StaticResource IsNotNullConverter}}">
                        <Label Text="Antecedentes Médicos" FontSize="12" TextColor="#F39C12" FontAttributes="Bold" />
                        <Frame BackgroundColor="#FEF9E7" CornerRadius="8" Padding="10" HasShadow="False">
                            <Label Text="{Binding PacienteEncontrado.AntecedentesMedicos}" FontSize="13" TextColor="#F39C12" LineBreakMode="WordWrap" />
                        </Frame>
                    </StackLayout>
                </StackLayout>
            </Frame>

            <!-- ESTADÍSTICAS -->
            <Frame BackgroundColor="White" 
                   CornerRadius="12" 
                   HasShadow="True" 
                   Padding="20"
                   IsVisible="{Binding ShowResults}">
                <StackLayout Spacing="15">

                    <Label Text="Resumen Estadístico" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#2C3E50" />

                    <Grid ColumnDefinitions="*,*" RowDefinitions="*,*" ColumnSpacing="12" RowSpacing="12">

                        <!-- Total Citas -->
                        <Frame Grid.Row="0" Grid.Column="0" 
                               BackgroundColor="#E8F6F3" 
                               CornerRadius="10" 
                               HasShadow="False" 
                               Padding="15">
                            <StackLayout Spacing="5">
                                <Label Text="{Binding Estadisticas.TotalCitas}" 
                                       FontSize="24" 
                                       FontAttributes="Bold" 
                                       TextColor="#27AE60" 
                                       HorizontalOptions="Center" />
                                <Label Text="Total Citas" 
                                       FontSize="12" 
                                       FontAttributes="Bold"
                                       TextColor="#27AE60" 
                                       HorizontalOptions="Center" />
                            </StackLayout>
                        </Frame>

                        <!-- Completadas -->
                        <Frame Grid.Row="0" Grid.Column="1" 
                               BackgroundColor="#EBF5FF" 
                               CornerRadius="10" 
                               HasShadow="False" 
                               Padding="15">
                            <StackLayout Spacing="5">
                                <Label Text="{Binding Estadisticas.CitasCompletadas}" 
                                       FontSize="24" 
                                       FontAttributes="Bold" 
                                       TextColor="#3498DB" 
                                       HorizontalOptions="Center" />
                                <Label Text="Completadas" 
                                       FontSize="12" 
                                       FontAttributes="Bold"
                                       TextColor="#3498DB" 
                                       HorizontalOptions="Center" />
                            </StackLayout>
                        </Frame>

                        <!-- Pendientes -->
                        <Frame Grid.Row="1" Grid.Column="0" 
                               BackgroundColor="#FEF9E7" 
                               CornerRadius="10" 
                               HasShadow="False" 
                               Padding="15">
                            <StackLayout Spacing="5">
                                <Label Text="{Binding Estadisticas.CitasPendientes}" 
                                       FontSize="24" 
                                       FontAttributes="Bold" 
                                       TextColor="#F39C12" 
                                       HorizontalOptions="Center" />
                                <Label Text="Pendientes" 
                                       FontSize="12" 
                                       FontAttributes="Bold"
                                       TextColor="#F39C12" 
                                       HorizontalOptions="Center" />
                            </StackLayout>
                        </Frame>

                        <!-- Canceladas -->
                        <Frame Grid.Row="1" Grid.Column="1" 
                               BackgroundColor="#FADBD8" 
                               CornerRadius="10" 
                               HasShadow="False" 
                               Padding="15">
                            <StackLayout Spacing="5">
                                <Label Text="{Binding Estadisticas.CitasCanceladas}" 
                                       FontSize="24" 
                                       FontAttributes="Bold" 
                                       TextColor="#E74C3C" 
                                       HorizontalOptions="Center" />
                                <Label Text="Canceladas" 
                                       FontSize="12" 
                                       FontAttributes="Bold"
                                       TextColor="#E74C3C" 
                                       HorizontalOptions="Center" />
                            </StackLayout>
                        </Frame>
                    </Grid>
                </StackLayout>
            </Frame>

            <!-- LISTA DE CITAS -->
            <Frame BackgroundColor="White" 
                   CornerRadius="12" 
                   HasShadow="True" 
                   Padding="20"
                   IsVisible="{Binding ShowResults}">
                <StackLayout Spacing="15">

                    <Label Text="Historial de Citas Médicas" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#2C3E50" />

                    <CollectionView ItemsSource="{Binding Citas}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:CitaMedica">
                                <Grid Padding="0,0,0,15">
                                    <Frame BackgroundColor="White" 
                                           CornerRadius="10" 
                                           HasShadow="True" 
                                           Padding="16">
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:HistorialClinicoViewModel}}, Path=VerDetalleCitaCommand}"
                                                                  CommandParameter="{Binding .}" />
                                        </Frame.GestureRecognizers>

                                        <StackLayout Spacing="12">

                                            <!-- Header: Fecha y Estado -->
                                            <Grid ColumnDefinitions="*,Auto">
                                                <Label Grid.Column="0"
                                                       Text="{Binding FechaHora}" 
                                                       FontSize="16" 
                                                       FontAttributes="Bold" 
                                                       TextColor="#2C3E50" />

                                                <Frame Grid.Column="1"
                                                       BackgroundColor="{Binding EstadoColor}" 
                                                       CornerRadius="12" 
                                                       Padding="8,4"
                                                       HasShadow="False"
                                                       VerticalOptions="Start">
                                                    <Label Text="{Binding Estado}" 
                                                           FontSize="11" 
                                                           FontAttributes="Bold" 
                                                           TextColor="White" />
                                                </Frame>
                                            </Grid>

                                            <!-- Información del médico -->
                                            <StackLayout Spacing="4">
                                                <Label Text="{Binding DoctorCompleto}" 
                                                       FontSize="15" 
                                                       FontAttributes="Bold"
                                                       TextColor="#3498DB" />

                                                <Label Text="{Binding EspecialidadNombre}" 
                                                       FontSize="13" 
                                                       TextColor="#7F8C8D" />

                                                <Label Text="{Binding SucursalNombre}" 
                                                       FontSize="12" 
                                                       TextColor="#95A5A6" />
                                            </StackLayout>

                                            <!-- Motivo de consulta -->
                                            <Frame BackgroundColor="#F8F9FA" 
                                                   CornerRadius="8" 
                                                   HasShadow="False" 
                                                   Padding="12"
                                                   IsVisible="{Binding MotivoConsulta, Converter={StaticResource IsNotNullConverter}}">
                                                <StackLayout Spacing="4">
                                                    <Label Text="Motivo de Consulta:" 
                                                           FontSize="12" 
                                                           FontAttributes="Bold" 
                                                           TextColor="#34495E" />
                                                    <Label Text="{Binding MotivoConsulta}" 
                                                           FontSize="13" 
                                                           TextColor="#2C3E50"
                                                           LineBreakMode="WordWrap" />
                                                </StackLayout>
                                            </Frame>

                                            <!-- Diagnóstico -->
                                            <Frame BackgroundColor="#E8F8F5" 
                                                   CornerRadius="8" 
                                                   HasShadow="False" 
                                                   Padding="12"
                                                   IsVisible="{Binding Diagnostico, Converter={StaticResource IsNotNullConverter}}">
                                                <StackLayout Spacing="4">
                                                    <Label Text="Diagnóstico:" 
                                                           FontSize="12" 
                                                           FontAttributes="Bold" 
                                                           TextColor="#27AE60" />
                                                    <Label Text="{Binding Diagnostico}" 
                                                           FontSize="13" 
                                                           TextColor="#2C3E50"
                                                           LineBreakMode="WordWrap" />
                                                </StackLayout>
                                            </Frame>

                                            <!-- Tratamiento -->
                                            <Frame BackgroundColor="#FEF9E7" 
                                                   CornerRadius="8" 
                                                   HasShadow="False" 
                                                   Padding="12"
                                                   IsVisible="{Binding Tratamiento, Converter={StaticResource IsNotNullConverter}}">
                                                <StackLayout Spacing="4">
                                                    <Label Text="Tratamiento:" 
                                                           FontSize="12" 
                                                           FontAttributes="Bold" 
                                                           TextColor="#F39C12" />
                                                    <Label Text="{Binding Tratamiento}" 
                                                           FontSize="13" 
                                                           TextColor="#2C3E50"
                                                           LineBreakMode="WordWrap" />
                                                </StackLayout>
                                            </Frame>

                                            <!-- Indicadores de proceso -->
                                            <Grid ColumnDefinitions="*,*" IsVisible="{Binding TieneTriaje}">
                                                <Label Grid.Column="0"
                                                       Text="Triaje Completo" 
                                                       FontSize="12" 
                                                       FontAttributes="Bold"
                                                       TextColor="#27AE60" 
                                                       IsVisible="{Binding TieneTriaje}" />

                                                <Label Grid.Column="1"
                                                       Text="Consulta Realizada" 
                                                       FontSize="12" 
                                                       FontAttributes="Bold"
                                                       TextColor="#3498DB"
                                                       HorizontalOptions="End" 
                                                       IsVisible="{Binding TieneConsulta}" />
                                            </Grid>

                                        </StackLayout>
                                    </Frame>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Mensaje cuando no hay citas -->
                    <Frame BackgroundColor="#F8F9FA" 
                           CornerRadius="8" 
                           HasShadow="False" 
                           Padding="20"
                           IsVisible="{Binding Citas.Count, Converter={StaticResource EqualConverter}, ConverterParameter=0}">
                        <StackLayout Spacing="10" HorizontalOptions="Center">
                            <Label Text="📋" 
                                   FontSize="40" 
                                   HorizontalOptions="Center" 
                                   TextColor="#BDC3C7" />
                            <Label Text="No se encontraron citas médicas"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#7F8C8D"
                                   HorizontalOptions="Center" />
                            <Label Text="Intente ajustar los filtros de búsqueda"
                                   FontSize="14"
                                   TextColor="#95A5A6"
                                   HorizontalOptions="Center" />
                        </StackLayout>
                    </Frame>
                </StackLayout>
            </Frame>

            <!-- Espaciado inferior -->
            <BoxView HeightRequest="20" Color="Transparent" />

        </StackLayout>
    </ScrollView>
</ContentPage>