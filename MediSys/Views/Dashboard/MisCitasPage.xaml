<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MediSys.ViewModels"
             xmlns:models="clr-namespace:MediSys.Models"
             xmlns:local2="clr-namespace:MediSys.Converters"
             x:Class="MediSys.Views.Dashboard.MisCitasPage"
             x:DataType="viewmodels:MisCitasViewModel"
             Title="Mis Citas Médicas"
             BackgroundColor="#F5F7FA">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- CONVERTERS -->
            <local2:ObjectToBoolConverter x:Key="ObjectToBoolConverter" />
            <local2:BoolToStringConverter x:Key="BoolToStringConverter" />
            <local2:StringEqualToBoolConverter x:Key="StringEqualToBoolConverter" />
            <local2:InverseBoolConverter x:Key="InverseBoolConverter" />

            <!-- COLORES MODERNOS -->
            <Color x:Key="PrimaryBlue">#2563EB</Color>
            <Color x:Key="AccentBlue">#3B82F6</Color>
            <Color x:Key="SuccessGreen">#10B981</Color>
            <Color x:Key="WarningOrange">#F59E0B</Color>
            <Color x:Key="DangerRed">#EF4444</Color>
            <Color x:Key="CardBackground">#FFFFFF</Color>
            <Color x:Key="BackgroundGray">#F9FAFB</Color>
            <Color x:Key="TextPrimary">#111827</Color>
            <Color x:Key="TextSecondary">#6B7280</Color>
            <Color x:Key="TextLight">#9CA3AF</Color>
            <Color x:Key="BorderLight">#E5E7EB</Color>

            <!-- ESTILOS MEJORADOS -->
            <Style x:Key="HeaderCardStyle" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="{StaticResource CardBackground}" />
                <Setter Property="HasShadow" Value="True" />
                <Setter Property="CornerRadius" Value="20" />
                <Setter Property="Padding" Value="24" />
                <Setter Property="Margin" Value="16,16,16,12" />
            </Style>

            <Style x:Key="CitaCardStyle" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="{StaticResource CardBackground}" />
                <Setter Property="HasShadow" Value="True" />
                <Setter Property="CornerRadius" Value="16" />
                <Setter Property="Padding" Value="20" />
                <Setter Property="Margin" Value="16,8" />
            </Style>

            <Style x:Key="TitleStyle" TargetType="Label">
                <Setter Property="FontSize" Value="20" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{StaticResource TextPrimary}" />
            </Style>

            <Style x:Key="SubtitleStyle" TargetType="Label">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="TextColor" Value="{StaticResource TextSecondary}" />
            </Style>

            <Style x:Key="StatNumberStyle" TargetType="Label">
                <Setter Property="FontSize" Value="28" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="HorizontalOptions" Value="Center" />
            </Style>

            <Style x:Key="StatLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="TextColor" Value="{StaticResource TextSecondary}" />
                <Setter Property="HorizontalOptions" Value="Center" />
                <Setter Property="FontAttributes" Value="Bold" />
            </Style>

            <Style x:Key="ActionButtonStyle" TargetType="Button">
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="13" />
                <Setter Property="HeightRequest" Value="40" />
                <Setter Property="Padding" Value="16,0" />
            </Style>

            <Style x:Key="FilterButtonStyle" TargetType="Button">
                <Setter Property="CornerRadius" Value="10" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="16" />
                <Setter Property="WidthRequest" Value="44" />
                <Setter Property="HeightRequest" Value="44" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <RefreshView IsRefreshing="{Binding IsRefreshing}"
                 Command="{Binding RefrescarCitasCommand}"
                 RefreshColor="{StaticResource AccentBlue}">

        <ScrollView BackgroundColor="{StaticResource BackgroundGray}">
            <StackLayout Spacing="0">

                <!-- HEADER CON ESTADÍSTICAS Y FILTROS -->
                <Frame Style="{StaticResource HeaderCardStyle}">
                    <StackLayout Spacing="20">

                        <!-- Título Principal -->
                        <StackLayout Spacing="4">
                            <Label Text="Panel de Consultas Médicas" 
                                   Style="{StaticResource TitleStyle}"
                                   FontSize="24" />
                            <Label Text="{Binding FechaSeleccionada, StringFormat='{0:dddd, dd \\de MMMM \\de yyyy}'}" 
                                   Style="{StaticResource SubtitleStyle}"
                                   FontSize="16" />
                        </StackLayout>

                        <!-- Estadísticas en Cards -->
                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="12">

                            <!-- Total Citas -->
                            <Frame Grid.Column="0" 
                                   BackgroundColor="#EBF4FF" 
                                   BorderColor="{StaticResource AccentBlue}"
                                   CornerRadius="12" 
                                   HasShadow="False" 
                                   Padding="16,12">
                                <StackLayout Spacing="4">
                                    <Label Text="{Binding TotalCitas}" 
                                           Style="{StaticResource StatNumberStyle}"
                                           TextColor="{StaticResource AccentBlue}" />
                                    <Label Text="Total" 
                                           Style="{StaticResource StatLabelStyle}" />
                                </StackLayout>
                            </Frame>

                            <!-- Pendientes -->
                            <Frame Grid.Column="1" 
                                   BackgroundColor="#FEF3C7" 
                                   BorderColor="{StaticResource WarningOrange}"
                                   CornerRadius="12" 
                                   HasShadow="False" 
                                   Padding="16,12">
                                <StackLayout Spacing="4">
                                    <Label Text="{Binding CitasPendientes}" 
                                           Style="{StaticResource StatNumberStyle}"
                                           TextColor="{StaticResource WarningOrange}" />
                                    <Label Text="Pendientes" 
                                           Style="{StaticResource StatLabelStyle}" />
                                </StackLayout>
                            </Frame>

                            <!-- Completadas -->
                            <Frame Grid.Column="2" 
                                   BackgroundColor="#D1FAE5" 
                                   BorderColor="{StaticResource SuccessGreen}"
                                   CornerRadius="12" 
                                   HasShadow="False" 
                                   Padding="16,12">
                                <StackLayout Spacing="4">
                                    <Label Text="{Binding CitasCompletadas}" 
                                           Style="{StaticResource StatNumberStyle}"
                                           TextColor="{StaticResource SuccessGreen}" />
                                    <Label Text="Completadas" 
                                           Style="{StaticResource StatLabelStyle}" />
                                </StackLayout>
                            </Frame>
                        </Grid>

                        <!-- Controles de Filtrado -->
                        <Frame BackgroundColor="{StaticResource BackgroundGray}" 
                               BorderColor="{StaticResource BorderLight}"
                               CornerRadius="12" 
                               HasShadow="False" 
                               Padding="16">
                            <Grid ColumnDefinitions="*,*,Auto" ColumnSpacing="12">

                                <!-- Selector de Fecha -->
                                <StackLayout Grid.Column="0">
                                    <Label Text="Fecha" 
                                           FontSize="13" 
                                           FontAttributes="Bold" 
                                           TextColor="{StaticResource TextSecondary}"
                                           Margin="0,0,0,4" />
                                    <Frame BackgroundColor="White" 
                                           BorderColor="{StaticResource BorderLight}"
                                           CornerRadius="8" 
                                           HasShadow="False" 
                                           Padding="12,8">
                                        <DatePicker x:Name="FechaPicker"
                                                    Date="{Binding FechaSeleccionada}" 
                                                    BackgroundColor="Transparent"
                                                    TextColor="{StaticResource TextPrimary}"
                                                    DateSelected="OnFechaChanged" />
                                    </Frame>
                                </StackLayout>

                                <!-- Selector de Estado -->
                                <StackLayout Grid.Column="1">
                                    <Label Text="Estado" 
                                           FontSize="13" 
                                           FontAttributes="Bold" 
                                           TextColor="{StaticResource TextSecondary}"
                                           Margin="0,0,0,4" />
                                    <Frame BackgroundColor="White" 
                                           BorderColor="{StaticResource BorderLight}"
                                           CornerRadius="8" 
                                           HasShadow="False" 
                                           Padding="12,8">
                                        <Picker x:Name="EstadoPicker"
                                                ItemsSource="{Binding EstadosDisponibles}"
                                                SelectedItem="{Binding EstadoFiltro}"
                                                BackgroundColor="Transparent"
                                                TextColor="{StaticResource TextPrimary}"
                                                SelectedIndexChanged="OnEstadoChanged" />
                                    </Frame>
                                </StackLayout>

                                <!-- Botones de Acción -->
                                <StackLayout Grid.Column="2" 
                                             Spacing="8"
                                             VerticalOptions="End">
                                    <Button Text="🔄" 
                                            Command="{Binding RefrescarCitasCommand}"
                                            BackgroundColor="{StaticResource AccentBlue}"
                                            TextColor="White"
                                            Style="{StaticResource FilterButtonStyle}" />

                                    <Button Text="🚨" 
                                            Command="{Binding FiltrarUrgentesCommand}"
                                            BackgroundColor="{StaticResource DangerRed}"
                                            TextColor="White"
                                            Style="{StaticResource FilterButtonStyle}" />
                                </StackLayout>
                            </Grid>
                        </Frame>
                    </StackLayout>
                </Frame>

                <!-- LOADING INDICATOR -->
                <ActivityIndicator IsVisible="{Binding IsLoading}" 
                                   IsRunning="{Binding IsLoading}"
                                   Color="{StaticResource AccentBlue}" 
                                   VerticalOptions="Center" 
                                   Margin="0,20"
                                   HeightRequest="40" />

                <!-- LISTA DE CITAS CON BINDABLELAYOUT -->
                <StackLayout BindableLayout.ItemsSource="{Binding Citas}" 
                             Spacing="0"
                             IsVisible="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="models:CitaConsultaMedica">

                            <!-- CARD DE CITA INDIVIDUAL -->
                            <Frame Style="{StaticResource CitaCardStyle}">
                                <StackLayout Spacing="16">

                                    <!-- HEADER CON INFO DEL PACIENTE Y ESTADO -->
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="16">

                                        <!-- Info del Paciente -->
                                        <StackLayout Grid.Column="0" Spacing="4">
                                            <Label Text="{Binding Paciente.NombreCompleto}" 
                                                   FontSize="18" 
                                                   FontAttributes="Bold" 
                                                   TextColor="{StaticResource TextPrimary}"
                                                   LineBreakMode="TailTruncation" />

                                            <StackLayout Orientation="Horizontal" Spacing="16">
                                                <Label Text="{Binding Paciente.Cedula, StringFormat='CI: {0}'}" 
                                                       FontSize="13" 
                                                       TextColor="{StaticResource TextSecondary}"
                                                       FontAttributes="Bold" />
                                                <Label Text="{Binding Paciente.Telefono, StringFormat='Tel: {0}'}" 
                                                       FontSize="13" 
                                                       TextColor="{StaticResource TextSecondary}" />
                                            </StackLayout>
                                        </StackLayout>

                                        <!-- Estado y Hora -->
                                        <StackLayout Grid.Column="1" 
                                                     HorizontalOptions="End" 
                                                     Spacing="4">

                                            <!-- Badge de Estado -->
                                            <Frame BackgroundColor="{Binding EstadoColor}" 
                                                   CornerRadius="12" 
                                                   HasShadow="False" 
                                                   Padding="12,6"
                                                   HorizontalOptions="End">
                                                <Label Text="{Binding Estado}" 
                                                       TextColor="White" 
                                                       FontSize="11" 
                                                       FontAttributes="Bold"
                                                       HorizontalOptions="Center" />
                                            </Frame>

                                            <!-- Hora -->
                                            <Label Text="{Binding HoraDisplay}" 
                                                   FontSize="18" 
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource PrimaryBlue}"
                                                   HorizontalOptions="End" />
                                        </StackLayout>
                                    </Grid>

                                    <!-- INFORMACIÓN DE LA CITA -->
                                    <Frame BackgroundColor="{StaticResource BackgroundGray}" 
                                           CornerRadius="10" 
                                           HasShadow="False" 
                                           Padding="16">
                                        <StackLayout Spacing="8">
                                            <Label Text="{Binding Motivo, StringFormat='Motivo: {0}'}" 
                                                   FontSize="14" 
                                                   TextColor="{StaticResource TextPrimary}"
                                                   FontAttributes="Bold" />

                                            <StackLayout Orientation="Horizontal" Spacing="20">
                                                <Label Text="{Binding Sucursal, StringFormat='Sucursal: {0}'}" 
                                                       FontSize="13" 
                                                       TextColor="{StaticResource TextSecondary}" />
                                                <Label Text="{Binding TipoCita, StringFormat='Modalidad: {0}'}" 
                                                       FontSize="13" 
                                                       TextColor="{StaticResource TextSecondary}" />
                                            </StackLayout>
                                        </StackLayout>
                                    </Frame>

                                    <!-- INFORMACIÓN DE TRIAJE (si existe) -->
                                    <Frame IsVisible="{Binding Triaje, Converter={StaticResource ObjectToBoolConverter}}"
                                           BackgroundColor="#FEF3E2" 
                                           BorderColor="{StaticResource WarningOrange}"
                                           CornerRadius="10" 
                                           HasShadow="False" 
                                           Padding="16">
                                        <StackLayout Spacing="10">
                                            <Label Text="Datos de Triaje" 
                                                   FontSize="15" 
                                                   FontAttributes="Bold" 
                                                   TextColor="{StaticResource WarningOrange}" />

                                            <!-- Signos Vitales en Grid -->
                                            <Grid ColumnDefinitions="*,*" 
                                                  RowDefinitions="Auto,Auto,Auto" 
                                                  ColumnSpacing="16" 
                                                  RowSpacing="6">

                                                <Label Grid.Row="0" Grid.Column="0" 
                                                       Text="{Binding Triaje.PresionArterial, StringFormat='PA: {0}'}" 
                                                       FontSize="13" 
                                                       TextColor="{StaticResource TextPrimary}" />

                                                <Label Grid.Row="0" Grid.Column="1" 
                                                       Text="{Binding Triaje.Temperatura, StringFormat='Temp: {0}°C'}" 
                                                       FontSize="13" 
                                                       TextColor="{StaticResource TextPrimary}" />

                                                <Label Grid.Row="1" Grid.Column="0" 
                                                       Text="{Binding Triaje.FrecuenciaCardiaca, StringFormat='FC: {0} bpm'}" 
                                                       FontSize="13" 
                                                       TextColor="{StaticResource TextPrimary}" />

                                                <Label Grid.Row="1" Grid.Column="1" 
                                                       Text="{Binding Triaje.SaturacionOxigeno, StringFormat='SpO2: {0}%'}" 
                                                       FontSize="13" 
                                                       TextColor="{StaticResource TextPrimary}" />

                                                <Label Grid.Row="2" Grid.Column="0" 
                                                       Text="{Binding Triaje.Peso, StringFormat='Peso: {0} kg'}" 
                                                       FontSize="13" 
                                                       TextColor="{StaticResource TextPrimary}" />

                                                <Label Grid.Row="2" Grid.Column="1" 
                                                       Text="{Binding Triaje.Talla, StringFormat='Talla: {0} cm'}" 
                                                       FontSize="13" 
                                                       TextColor="{StaticResource TextPrimary}" />
                                            </Grid>

                                            <!-- Alerta de Urgencia -->
                                            <Frame IsVisible="{Binding EsUrgente}"
                                                   BackgroundColor="#FEE2E2"
                                                   BorderColor="{StaticResource DangerRed}"
                                                   CornerRadius="8" 
                                                   HasShadow="False" 
                                                   Padding="12">
                                                <Label Text="{Binding Triaje.NivelUrgencia, StringFormat='URGENTE - Nivel {0}'}" 
                                                       TextColor="{StaticResource DangerRed}" 
                                                       FontAttributes="Bold"
                                                       FontSize="13"
                                                       HorizontalOptions="Center" />
                                            </Frame>
                                        </StackLayout>
                                    </Frame>

                                    <!-- BOTONES DE ACCIÓN -->
                                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">

                                        <Button Grid.Column="0"
                                                Text="Ver Detalle" 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MisCitasViewModel}}, Path=VerDetalleCitaCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="{StaticResource AccentBlue}"
                                                TextColor="White"
                                                Style="{StaticResource ActionButtonStyle}" />

                                        <Button Grid.Column="1"
                                                Text="Iniciar Consulta" 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MisCitasViewModel}}, Path=IniciarConsultaCommand}"
                                                CommandParameter="{Binding .}"
                                                IsVisible="{Binding PuedeConsultar}"
                                                BackgroundColor="{StaticResource SuccessGreen}"
                                                TextColor="White"
                                                Style="{StaticResource ActionButtonStyle}" />

                                        <Button Grid.Column="1"
                                                Text="Ver Consulta" 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MisCitasViewModel}}, Path=EditarConsultaCommand}"
                                                CommandParameter="{Binding .}"
                                                IsVisible="{Binding TieneConsulta}"
                                                BackgroundColor="{StaticResource WarningOrange}"
                                                TextColor="White"
                                                Style="{StaticResource ActionButtonStyle}" />

                                        <Button Grid.Column="2"
                                                Text="No Asistió" 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MisCitasViewModel}}, Path=MarcarComoNoAsistioCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="{StaticResource DangerRed}"
                                                TextColor="White"
                                                Style="{StaticResource ActionButtonStyle}" />
                                    </Grid>

                                    <!-- Indicador de Consulta Completada -->
                                    <Frame IsVisible="{Binding TieneConsulta}"
                                           BackgroundColor="#D1FAE5"
                                           BorderColor="{StaticResource SuccessGreen}"
                                           CornerRadius="8" 
                                           HasShadow="False" 
                                           Padding="12">
                                        <Label Text="Consulta médica completada" 
                                               TextColor="{StaticResource SuccessGreen}" 
                                               FontAttributes="Bold"
                                               FontSize="13"
                                               HorizontalOptions="Center" />
                                    </Frame>

                                </StackLayout>
                            </Frame>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>

                <!-- MENSAJE CUANDO NO HAY CITAS -->
                <StackLayout IsVisible="{Binding TieneCitas, Converter={StaticResource InverseBoolConverter}}" 
                             Padding="40" 
                             Spacing="24"
                             VerticalOptions="Center">

                    <Frame BackgroundColor="White" 
                           CornerRadius="20" 
                           HasShadow="True" 
                           Padding="32"
                           Margin="16">
                        <StackLayout Spacing="16">
                            <Label Text="📅" 
                                   FontSize="72" 
                                   HorizontalOptions="Center" 
                                   Opacity="0.3" />

                            <Label Text="{Binding MensajeVacio}" 
                                   FontSize="18" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextSecondary}"
                                   HorizontalOptions="Center" 
                                   HorizontalTextAlignment="Center"
                                   LineBreakMode="WordWrap" />

                            <Label Text="Puedes cambiar la fecha o el estado del filtro para ver más citas disponibles." 
                                   FontSize="14" 
                                   TextColor="{StaticResource TextLight}"
                                   HorizontalOptions="Center" 
                                   HorizontalTextAlignment="Center"
                                   LineBreakMode="WordWrap" />

                            <Button Text="Actualizar Lista" 
                                    Command="{Binding RefrescarCitasCommand}"
                                    BackgroundColor="{StaticResource AccentBlue}"
                                    TextColor="White"
                                    Style="{StaticResource ActionButtonStyle}"
                                    HorizontalOptions="Center"
                                    WidthRequest="160" />
                        </StackLayout>
                    </Frame>
                </StackLayout>

                <!-- PADDING BOTTOM -->
                <StackLayout HeightRequest="20" />

            </StackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>