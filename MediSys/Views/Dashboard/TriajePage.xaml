<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MediSys.ViewModels"
             xmlns:models="clr-namespace:MediSys.Models"
             xmlns:local2="clr-namespace:MediSys.Converters"
             x:Class="MediSys.Views.Dashboard.TriajePage"
             x:DataType="viewmodels:TriajeViewModel"
             Title="Triaje - Enfermería"
             BackgroundColor="#F0F4F8">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- COLORES MEJORADOS -->
            <Color x:Key="PrimaryBlue">#1E3A8A</Color>
            <Color x:Key="AccentBlue">#3B82F6</Color>
            <Color x:Key="SuccessGreen">#059669</Color>
            <Color x:Key="WarningOrange">#D97706</Color>
            <Color x:Key="DangerRed">#DC2626</Color>
            <Color x:Key="CardBackground">#FFFFFF</Color>
            <Color x:Key="InputBackground">#F8FAFC</Color>
            <Color x:Key="InputBorder">#E2E8F0</Color>
            <Color x:Key="TextPrimary">#1F2937</Color>
            <Color x:Key="TextSecondary">#6B7280</Color>
            <Color x:Key="TextLight">#9CA3AF</Color>
            <Color x:Key="SelectedBackground">#EBF4FF</Color>
            <Color x:Key="SelectedBorder">#3B82F6</Color>

            <!-- CONVERTERS -->
            <local2:ObjectToBoolConverter x:Key="ObjectToBoolConverter" />
            <local2:CountToBoolConverter x:Key="CountToBoolConverter" />

            <!-- ESTILOS GLOBALES -->
            <Style x:Key="CardFrameStyle" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="{StaticResource CardBackground}" />
                <Setter Property="HasShadow" Value="True" />
                <Setter Property="CornerRadius" Value="16" />
                <Setter Property="Padding" Value="24" />
                <Setter Property="Margin" Value="0,8" />
            </Style>

            <Style x:Key="SectionTitleStyle" TargetType="Label">
                <Setter Property="FontSize" Value="20" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{StaticResource TextPrimary}" />
                <Setter Property="Margin" Value="0,0,0,16" />
            </Style>

            <Style x:Key="FieldLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{StaticResource TextPrimary}" />
                <Setter Property="Margin" Value="0,0,0,6" />
            </Style>

            <Style x:Key="InputFrameStyle" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="{StaticResource InputBackground}" />
                <Setter Property="HasShadow" Value="False" />
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="Padding" Value="16,12" />
                <Setter Property="BorderColor" Value="{StaticResource InputBorder}" />
            </Style>

            <Style x:Key="InputEntryStyle" TargetType="Entry">
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="TextColor" Value="{StaticResource TextPrimary}" />
                <Setter Property="PlaceholderColor" Value="{StaticResource TextLight}" />
                <Setter Property="FontSize" Value="16" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView Padding="16">
        <StackLayout Spacing="16">

            <!-- HEADER MEJORADO -->
            <Frame Style="{StaticResource CardFrameStyle}" Padding="20">
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="20">
                    <Frame Grid.Column="0"
                           BackgroundColor="{StaticResource AccentBlue}"
                           WidthRequest="70" 
                           HeightRequest="70"
                           CornerRadius="35"
                           HasShadow="False"
                           Padding="0">
                        <Label Text="🩺" 
                               FontSize="32" 
                               TextColor="White"
                               HorizontalOptions="Center" 
                               VerticalOptions="Center" />
                    </Frame>
                    <StackLayout Grid.Column="1" VerticalOptions="Center" Spacing="4">
                        <Label Text="Triaje de Enfermería" 
                               FontSize="26" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource TextPrimary}" />
                        <Label Text="Sistema de evaluación y registro de signos vitales" 
                               FontSize="15" 
                               TextColor="{StaticResource TextSecondary}" />
                    </StackLayout>
                </Grid>
            </Frame>

            <!-- PASO 1: BUSCAR PACIENTE MEJORADO -->
            <Frame Style="{StaticResource CardFrameStyle}">
                <StackLayout Spacing="20">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Frame BackgroundColor="{StaticResource PrimaryBlue}"
                               WidthRequest="32" HeightRequest="32"
                               CornerRadius="16" HasShadow="False" Padding="0">
                            <Label Text="1" FontSize="18" FontAttributes="Bold"
                                   TextColor="White" HorizontalOptions="Center" 
                                   VerticalOptions="Center" />
                        </Frame>
                        <Label Text="Buscar Paciente por Cédula" 
                               Style="{StaticResource SectionTitleStyle}"
                               VerticalOptions="Center" />
                    </StackLayout>

                    <StackLayout Spacing="12">
                        <Label Text="Número de Cédula" 
                               Style="{StaticResource FieldLabelStyle}" />

                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                            <Frame Grid.Column="0" Style="{StaticResource InputFrameStyle}">
                                <Entry Text="{Binding CedulaBusqueda}"
                                       Style="{StaticResource InputEntryStyle}"
                                       Placeholder="Ej: 1234567890"
                                       Keyboard="Numeric"
                                       MaxLength="10" />
                            </Frame>

                            <Button Grid.Column="1" 
                                    Text="Buscar"
                                    Command="{Binding BuscarPacienteCommand}"
                                    BackgroundColor="{StaticResource AccentBlue}"
                                    TextColor="White"
                                    FontSize="16"
                                    FontAttributes="Bold"
                                    WidthRequest="120"
                                    HeightRequest="56"
                                    CornerRadius="12" />
                        </Grid>
                    </StackLayout>

                    <!-- PACIENTE ENCONTRADO MEJORADO -->
                    <Frame IsVisible="{Binding PacienteEncontrado}"
                           BackgroundColor="#ECFDF5" 
                           HasShadow="False"
                           CornerRadius="12"
                           Padding="20"
                           BorderColor="{StaticResource SuccessGreen}">
                        <StackLayout Spacing="8">
                            <StackLayout Orientation="Horizontal" Spacing="8">
                                <Label Text="✅" FontSize="18" VerticalOptions="Center" />
                                <Label Text="Paciente Encontrado" 
                                       FontSize="16" 
                                       FontAttributes="Bold" 
                                       TextColor="{StaticResource SuccessGreen}"
                                       VerticalOptions="Center" />
                            </StackLayout>
                            <Label Text="{Binding PacienteSeleccionado.NombreCompleto}" 
                                   FontSize="18" 
                                   FontAttributes="Bold" 
                                   TextColor="{StaticResource TextPrimary}" />
                            <Label Text="{Binding PacienteSeleccionado.Correo}" 
                                   FontSize="14" 
                                   TextColor="{StaticResource TextSecondary}" />
                        </StackLayout>
                    </Frame>
                </StackLayout>
            </Frame>

            <!-- PASO 2: SELECCIONAR CITA MEJORADO -->
            <Frame IsVisible="{Binding MostrarCitas}"
                   Style="{StaticResource CardFrameStyle}">
                <StackLayout Spacing="20">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Frame BackgroundColor="{StaticResource PrimaryBlue}"
                               WidthRequest="32" HeightRequest="32"
                               CornerRadius="16" HasShadow="False" Padding="0">
                            <Label Text="2" FontSize="18" FontAttributes="Bold"
                                   TextColor="White" HorizontalOptions="Center" 
                                   VerticalOptions="Center" />
                        </Frame>
                        <Label Text="Seleccionar Cita para Triaje" 
                               Style="{StaticResource SectionTitleStyle}"
                               VerticalOptions="Center" />
                    </StackLayout>

                    <CollectionView ItemsSource="{Binding CitasDelDia}" 
                                   SelectedItem="{Binding CitaSeleccionada}" 
                                   SelectionMode="Single">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:CitaDetallada">
                                <Frame BackgroundColor="{StaticResource InputBackground}" 
                                       HasShadow="False"
                                       CornerRadius="12"
                                       Padding="20"
                                       Margin="0,4"
                                       BorderColor="Transparent">
                                    <StackLayout Spacing="12">
                                        <!-- HORA Y TIPO -->
                                        <StackLayout Orientation="Horizontal" Spacing="12">
                                            <Frame BackgroundColor="{StaticResource AccentBlue}"
                                                   WidthRequest="50" HeightRequest="50"
                                                   CornerRadius="25" HasShadow="False" Padding="0">
                                                <Label Text="🕐" FontSize="20" TextColor="White"
                                                       HorizontalOptions="Center" VerticalOptions="Center" />
                                            </Frame>
                                            <StackLayout VerticalOptions="Center" Spacing="2">
                                                <Label Text="{Binding FechaHoraDisplay}" 
                                                       FontSize="18" 
                                                       FontAttributes="Bold" 
                                                       TextColor="{StaticResource TextPrimary}" />
                                                <Label Text="{Binding TipoCitaNombre}" 
                                                       FontSize="14" 
                                                       TextColor="{StaticResource AccentBlue}" />
                                            </StackLayout>
                                        </StackLayout>

                                        <!-- DOCTOR Y ESPECIALIDAD -->
                                        <StackLayout Spacing="6">
                                            <StackLayout Orientation="Horizontal" Spacing="8">
                                                <Label Text="👨‍⚕️" FontSize="16" />
                                                <Label Text="{Binding DoctorCompleto}" 
                                                       FontSize="15" 
                                                       FontAttributes="Bold"
                                                       TextColor="{StaticResource TextPrimary}" />
                                            </StackLayout>
                                            <StackLayout Orientation="Horizontal" Spacing="8">
                                                <Label Text="🏥" FontSize="16" />
                                                <Label Text="{Binding NombreEspecialidad}" 
                                                       FontSize="14" 
                                                       TextColor="{StaticResource TextSecondary}" />
                                            </StackLayout>
                                            <StackLayout Orientation="Horizontal" Spacing="8">
                                                <Label Text="📋" FontSize="16" />
                                                <Label Text="{Binding Motivo}" 
                                                       FontSize="14" 
                                                       TextColor="{StaticResource TextPrimary}" />
                                            </StackLayout>
                                        </StackLayout>
                                    </StackLayout>

                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TriajeViewModel}}, Path=SeleccionarCitaCommand}"
                                                            CommandParameter="{Binding .}" />
                                    </Frame.GestureRecognizers>

                                    <!-- VISUAL STATE PARA SELECCIÓN -->
                                    <VisualStateManager.VisualStateGroups>
                                        <VisualStateGroup Name="CommonStates">
                                            <VisualState Name="Normal" />
                                            <VisualState Name="Selected">
                                                <VisualState.Setters>
                                                    <Setter Property="BackgroundColor" Value="{StaticResource SelectedBackground}" />
                                                    <Setter Property="BorderColor" Value="{StaticResource SelectedBorder}" />
                                                </VisualState.Setters>
                                            </VisualState>
                                        </VisualStateGroup>
                                    </VisualStateManager.VisualStateGroups>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>
            </Frame>

            <!-- PASO 3: FORMULARIO DE TRIAJE MEJORADO -->
            <Frame IsVisible="{Binding MostrarFormularioTriaje}"
                   Style="{StaticResource CardFrameStyle}">
                <StackLayout Spacing="24">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Frame BackgroundColor="{StaticResource PrimaryBlue}"
                               WidthRequest="32" HeightRequest="32"
                               CornerRadius="16" HasShadow="False" Padding="0">
                            <Label Text="3" FontSize="18" FontAttributes="Bold"
                                   TextColor="White" HorizontalOptions="Center" 
                                   VerticalOptions="Center" />
                        </Frame>
                        <Label Text="Registro de Triaje Médico" 
                               Style="{StaticResource SectionTitleStyle}"
                               VerticalOptions="Center" />
                    </StackLayout>

                    <!-- NIVEL DE URGENCIA MEJORADO -->
                    <StackLayout Spacing="16">
                        <Label Text="⚠️ Nivel de Urgencia (Requerido)" 
                   Style="{StaticResource FieldLabelStyle}"
                   TextColor="{StaticResource DangerRed}" />

                        <CollectionView ItemsSource="{Binding NivelesUrgencia}" 
                           SelectedItem="{Binding NivelUrgenciaSeleccionado}" 
                           SelectionMode="Single"
                           SelectionChangedCommand="{Binding SeleccionarNivelUrgenciaCommand}"
                           SelectionChangedCommandParameter="{Binding SelectedItem, Source={RelativeSource Self}}"
                           HeightRequest="100">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Horizontal" ItemSpacing="12" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:NivelUrgencia">
                                    <Frame BackgroundColor="{StaticResource InputBackground}" 
                               HasShadow="True"
                               CornerRadius="16"
                               Padding="16,12"
                               WidthRequest="90"
                               BorderColor="Transparent">

                                        <!-- Agregar TapGestureRecognizer como respaldo -->
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SeleccionarNivelUrgenciaCommand}"
                                                    CommandParameter="{Binding .}" />
                                        </Frame.GestureRecognizers>

                                        <StackLayout HorizontalOptions="Center" Spacing="6">
                                            <Label Text="{Binding Icono}" 
                                       FontSize="24" 
                                       HorizontalOptions="Center" />
                                            <Label Text="{Binding Nombre}" 
                                       FontSize="12" 
                                       FontAttributes="Bold" 
                                       HorizontalOptions="Center"
                                       TextColor="{StaticResource TextPrimary}"
                                       LineBreakMode="WordWrap"
                                       MaxLines="2" />
                                        </StackLayout>

                                        <!-- VISUAL STATE PARA SELECCIÓN -->
                                        <VisualStateManager.VisualStateGroups>
                                            <VisualStateGroup Name="CommonStates">
                                                <VisualState Name="Normal" />
                                                <VisualState Name="Selected">
                                                    <VisualState.Setters>
                                                        <Setter Property="BackgroundColor" Value="{StaticResource SelectedBackground}" />
                                                        <Setter Property="BorderColor" Value="{StaticResource SelectedBorder}" />
                                                    </VisualState.Setters>
                                                </VisualState>
                                            </VisualStateGroup>
                                        </VisualStateManager.VisualStateGroups>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>

                    <!-- SIGNOS VITALES MEJORADOS -->
                    <StackLayout Spacing="20">
                        <Label Text="🫀 Signos Vitales" 
                               Style="{StaticResource SectionTitleStyle}" />

                        <Grid RowDefinitions="Auto,Auto,Auto" 
                              ColumnDefinitions="*,*" 
                              RowSpacing="16" 
                              ColumnSpacing="16">

                            <!-- Temperatura -->
                            <StackLayout Grid.Row="0" Grid.Column="0" Spacing="8">
                                <Label Text="🌡️ Temperatura (°C)" 
                                       Style="{StaticResource FieldLabelStyle}" />
                                <Frame Style="{StaticResource InputFrameStyle}">
                                    <Entry Text="{Binding Temperatura}"
                                           Style="{StaticResource InputEntryStyle}"
                                           Placeholder="36.5" 
                                           Keyboard="Numeric" />
                                </Frame>
                            </StackLayout>

                            <!-- Frecuencia Cardíaca -->
                            <StackLayout Grid.Row="0" Grid.Column="1" Spacing="8">
                                <Label Text="💓 F. Cardíaca (lpm)" 
                                       Style="{StaticResource FieldLabelStyle}" />
                                <Frame Style="{StaticResource InputFrameStyle}">
                                    <Entry Text="{Binding FrecuenciaCardiaca}"
                                           Style="{StaticResource InputEntryStyle}"
                                           Placeholder="72"
                                           Keyboard="Numeric" />
                                </Frame>
                            </StackLayout>

                            <!-- Saturación -->
                            <StackLayout Grid.Row="1" Grid.Column="0" Spacing="8">
                                <Label Text="🫁 Saturación (%)" 
                                       Style="{StaticResource FieldLabelStyle}" />
                                <Frame Style="{StaticResource InputFrameStyle}">
                                    <Entry Text="{Binding SaturacionOxigeno}"
                                           Style="{StaticResource InputEntryStyle}"
                                           Placeholder="98"
                                           Keyboard="Numeric" />
                                </Frame>
                            </StackLayout>

                            <!-- Frecuencia Respiratoria -->
                            <StackLayout Grid.Row="1" Grid.Column="1" Spacing="8">
                                <Label Text="🫁 F. Respiratoria (rpm)" 
                                       Style="{StaticResource FieldLabelStyle}" />
                                <Frame Style="{StaticResource InputFrameStyle}">
                                    <Entry Text="{Binding FrecuenciaRespiratoria}"
                                           Style="{StaticResource InputEntryStyle}"
                                           Placeholder="16"
                                           Keyboard="Numeric" />
                                </Frame>
                            </StackLayout>
                        </Grid>

                        <!-- Presión Arterial -->
                        <StackLayout Spacing="8">
                            <Label Text="🩸 Presión Arterial (mmHg)" 
                                   Style="{StaticResource FieldLabelStyle}" />
                            <Grid ColumnDefinitions="*,Auto,*" ColumnSpacing="12">
                                <Frame Grid.Column="0" Style="{StaticResource InputFrameStyle}">
                                    <Entry Text="{Binding PresionSistolica}"
                                           Style="{StaticResource InputEntryStyle}"
                                           Placeholder="120"
                                           Keyboard="Numeric" />
                                </Frame>
                                <Label Grid.Column="1" 
                                       Text="/" 
                                       FontSize="24" 
                                       FontAttributes="Bold" 
                                       VerticalOptions="Center" 
                                       TextColor="{StaticResource TextPrimary}" />
                                <Frame Grid.Column="2" Style="{StaticResource InputFrameStyle}">
                                    <Entry Text="{Binding PresionDiastolica}"
                                           Style="{StaticResource InputEntryStyle}"
                                           Placeholder="80"
                                           Keyboard="Numeric" />
                                </Frame>
                            </Grid>
                        </StackLayout>
                    </StackLayout>

                    <!-- MEDIDAS ANTROPOMÉTRICAS MEJORADAS -->
                    <StackLayout Spacing="20">
                        <Label Text="📏 Medidas Antropométricas" 
                               Style="{StaticResource SectionTitleStyle}" />

                        <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                            <!-- Peso -->
                            <StackLayout Grid.Column="0" Spacing="8">
                                <Label Text="⚖️ Peso (kg)" 
                                       Style="{StaticResource FieldLabelStyle}" />
                                <Frame Style="{StaticResource InputFrameStyle}">
                                    <Entry Text="{Binding Peso}"
                                           Style="{StaticResource InputEntryStyle}"
                                           Placeholder="70.5"
                                           Keyboard="Numeric" />
                                </Frame>
                            </StackLayout>

                            <!-- Talla -->
                            <StackLayout Grid.Column="1" Spacing="8">
                                <Label Text="📏 Talla (cm)" 
                                       Style="{StaticResource FieldLabelStyle}" />
                                <Frame Style="{StaticResource InputFrameStyle}">
                                    <Entry Text="{Binding Talla}"
                                           Style="{StaticResource InputEntryStyle}"
                                           Placeholder="170"
                                           Keyboard="Numeric" />
                                </Frame>
                            </StackLayout>
                        </Grid>

                        <!-- IMC Calculado MEJORADO -->
                        <Frame IsVisible="{Binding ImcCalculado, Converter={StaticResource ObjectToBoolConverter}}"
                               BackgroundColor="#EFF6FF" 
                               HasShadow="False"
                               CornerRadius="12"
                               Padding="20"
                               BorderColor="{StaticResource AccentBlue}">
                            <StackLayout Orientation="Horizontal" Spacing="16">
                                <Frame BackgroundColor="{StaticResource AccentBlue}"
                                       WidthRequest="50" HeightRequest="50"
                                       CornerRadius="25" HasShadow="False" Padding="0">
                                    <Label Text="📊" FontSize="20" TextColor="White"
                                           HorizontalOptions="Center" VerticalOptions="Center" />
                                </Frame>
                                <StackLayout VerticalOptions="Center" Spacing="2">
                                    <Label Text="{Binding ImcCalculado, StringFormat='IMC: {0:F1}'}"
                                           FontSize="18" 
                                           FontAttributes="Bold" 
                                           TextColor="{StaticResource AccentBlue}" />
                                    <Label Text="{Binding CategoriaImc}" 
                                           FontSize="14" 
                                           TextColor="{StaticResource TextSecondary}" />
                                </StackLayout>
                            </StackLayout>
                        </Frame>
                    </StackLayout>

                    <!-- OBSERVACIONES MEJORADAS -->
                    <StackLayout Spacing="12">
                        <Label Text="📝 Observaciones del Enfermero" 
                               Style="{StaticResource FieldLabelStyle}" />
                        <Frame Style="{StaticResource InputFrameStyle}" Padding="16">
                            <Editor Text="{Binding Observaciones}"
                                    Placeholder="Escriba aquí cualquier observación relevante sobre el paciente..."
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource TextPrimary}"
                                    PlaceholderColor="{StaticResource TextLight}"
                                    FontSize="16"
                                    HeightRequest="80" />
                        </Frame>
                    </StackLayout>

                    <!-- ALERTAS MEJORADAS -->
                    <CollectionView ItemsSource="{Binding AlertasSignosVitales}"
                IsVisible="{Binding AlertasSignosVitales.Count, Converter={StaticResource CountToBoolConverter}}">
                        <CollectionView.Header>
                            <StackLayout Spacing="8" Margin="0,0,0,16">
                                <StackLayout Orientation="Horizontal" Spacing="8">
                                    <Frame BackgroundColor="{StaticResource WarningOrange}" 
                       WidthRequest="24" HeightRequest="24"
                       CornerRadius="12" HasShadow="False" Padding="0">
                                        <Label Text="!" FontSize="14" FontAttributes="Bold"
                           TextColor="White" HorizontalOptions="Center" 
                           VerticalOptions="Center" />
                                    </Frame>
                                    <Label Text="Alertas de Signos Vitales" 
                       Style="{StaticResource FieldLabelStyle}"
                       TextColor="{StaticResource WarningOrange}"
                       FontAttributes="Bold"
                       VerticalOptions="Center" />
                                </StackLayout>
                                <BoxView BackgroundColor="{StaticResource WarningOrange}" 
                     HeightRequest="2" 
                     CornerRadius="1"
                     Opacity="0.3" />
                            </StackLayout>
                        </CollectionView.Header>

                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame BackgroundColor="#FEF3C7" 
                   HasShadow="True"
                   CornerRadius="12"
                   Padding="0" 
                   Margin="0,6"
                   BorderColor="{StaticResource WarningOrange}"
                   HeightRequest="80">

                                    <!-- Borde izquierdo de color -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="4" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <!-- Indicador de color lateral -->
                                        <BoxView Grid.Column="0"
                             BackgroundColor="{StaticResource WarningOrange}"
                             CornerRadius="2,0,0,2" />

                                        <!-- Contenido principal -->
                                        <StackLayout Grid.Column="1" 
                                 Orientation="Horizontal" 
                                 Spacing="12"
                                 Padding="16"
                                 VerticalOptions="Center">

                                            <!-- Icono de alerta -->
                                            <Frame BackgroundColor="{StaticResource WarningOrange}" 
                               WidthRequest="36" HeightRequest="36"
                               CornerRadius="18" HasShadow="False" 
                               Padding="0"
                               VerticalOptions="Start">
                                                <Label Text="⚠️" 
                                   FontSize="18" 
                                   TextColor="White"
                                   HorizontalOptions="Center" 
                                   VerticalOptions="Center" />
                                            </Frame>

                                            <!-- Contenido del mensaje -->
                                            <StackLayout VerticalOptions="Center" 
                                     Spacing="4">
                                                <Label Text="ALERTA MÉDICA" 
                                   FontSize="11" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource WarningOrange}"
                                   Opacity="0.8" />
                                                <Label Text="{Binding}" 
                                   FontSize="14" 
                                   FontAttributes="None"
                                   TextColor="#92400E"
                                   LineBreakMode="WordWrap"
                                   MaxLines="3"
                                   VerticalOptions="Center" />
                                            </StackLayout>

                                            <!-- Indicador de prioridad -->
                                            <Label Text="●" 
                               FontSize="20" 
                               TextColor="{StaticResource DangerRed}"
                               VerticalOptions="Start"
                               Margin="0,2,0,0" />
                                        </StackLayout>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- BOTONES MEJORADOS -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="16" Margin="0,24,0,0">
                        <Button Grid.Column="0" 
                                Text="Cancelar"
                                Command="{Binding CancelarCommand}"
                                BackgroundColor="{StaticResource DangerRed}"
                                TextColor="White"
                                FontSize="18"
                                FontAttributes="Bold"
                                HeightRequest="56"
                                CornerRadius="12" />

                        <Button Grid.Column="1" 
                                Text="Guardar Triaje"
                                Command="{Binding GuardarTriajeCommand}"
                                BackgroundColor="{StaticResource SuccessGreen}"
                                TextColor="White"
                                FontSize="18"
                                FontAttributes="Bold"
                                HeightRequest="56"
                                CornerRadius="12"
                                IsEnabled="{Binding PuedeGuardarTriaje}" />
                    </Grid>
                </StackLayout>
            </Frame>

            <!-- LOADING INDICATOR MEJORADO -->
            <Frame IsVisible="{Binding IsLoading}" 
                   Style="{StaticResource CardFrameStyle}"
                   Padding="40">
                <StackLayout HorizontalOptions="Center" Spacing="20">
                    <ActivityIndicator IsRunning="{Binding IsLoading}" 
                                       Color="{StaticResource AccentBlue}" 
                                       WidthRequest="50"
                                       HeightRequest="50" />
                    <Label Text="Procesando triaje..." 
                           FontSize="16" 
                           FontAttributes="Bold"
                           TextColor="{StaticResource TextSecondary}"
                           HorizontalOptions="Center" />
                    <Label Text="Por favor espere un momento" 
                           FontSize="14" 
                           TextColor="{StaticResource TextLight}"
                           HorizontalOptions="Center" />
                </StackLayout>
            </Frame>

        </StackLayout>
    </ScrollView>
</ContentPage>